pipeline {
    agent any
    
    // Production-grade options - these save your life in production
    options {
        timeout(time: 30, unit: 'MINUTES')           // Never hang forever
        timestamps()                                  // Every log line timestamped
        buildDiscarder(logRotator(numToKeepStr: '10')) // Keep only last 10 builds
        skipDefaultCheckout()                         // We'll checkout manually
    }
    
    // Environment variables for production
    environment {
        APP_NAME = 'production-microservice'
        DOCKER_REGISTRY = 'your-registry.com'
        SLACK_CHANNEL = '#deployments'
        LOG_LEVEL = 'INFO'
        BUILD_TIMESTAMP = "${new Date().format('yyyyMMdd-HHmmss')}"
    }
    
    stages {
        stage('ğŸ” Code Quality Gate') {
            steps {
                script {
                    echo "ğŸ” Running production-grade quality checks..."
                    
                    // Checkout with proper error handling
                    checkout scm
                    
                    // Analyze only Jenkins folder with essential information
                    sh '''
                        echo ""
                        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                        echo "â•‘                        ğŸ“Š JENKINS PROJECT ANALYSIS                           â•‘"
                        echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
                        
                        # Focus only on Jenkins-related files
                        JENKINS_FILES=$(find . -name 'Jenkinsfile' | wc -l)
                        PYTHON_FILES=$(find . -name '*.py' | wc -l)
                        JENKINS_LINES=$(find . -name 'Jenkinsfile' -exec wc -l {} + | tail -1 | awk '{print $1}')
                        DIR_SIZE=$(du -sh . | cut -f1)
                        HOSTNAME=$(hostname)
                        IP_ADDRESS=$(hostname -I | awk '{print $1}')
                        UPTIME=$(uptime -p)
                        
                        echo "â•‘  ğŸ—ï¸  Jenkins Project:"
                        echo "â•‘     â€¢ Jenkins files: $JENKINS_FILES"
                        echo "â•‘     â€¢ Python scripts: $PYTHON_FILES"
                        echo "â•‘     â€¢ Jenkins code lines: $JENKINS_LINES"
                        echo "â•‘     â€¢ Project size: $DIR_SIZE"
                        echo "â•‘"
                        echo "â•‘  ğŸ–¥ï¸  System Information:"
                        echo "â•‘     â€¢ Hostname: $HOSTNAME"
                        echo "â•‘     â€¢ IP address: $IP_ADDRESS"
                        echo "â•‘     â€¢ System uptime: $UPTIME"
                        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                        echo ""
                    '''
                }
            }
        }
        
        stage('ğŸ–¥ï¸ System Information') {
            steps {
                sh '''
                    echo ""
                    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                    echo "â•‘                        ğŸ–¥ï¸  SYSTEM INFORMATION                              â•‘"
                    echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
                    
                    # System resources
                    CPU_CORES=$(nproc)
                    TOTAL_MEM=$(free -h | grep Mem | awk '{print $2}')
                    USED_MEM=$(free -h | grep Mem | awk '{print $3}')
                    AVAIL_MEM=$(free -h | grep Mem | awk '{print $7}')
                    DISK_TOTAL=$(df -h . | tail -1 | awk '{print $2}')
                    DISK_USED=$(df -h . | tail -1 | awk '{print $3}')
                    DISK_AVAIL=$(df -h . | tail -1 | awk '{print $4}')
                    LOAD_AVG=$(uptime | awk -F'load average:' '{print $2}')
                    
                    echo "â•‘  ğŸ’» System Resources:"
                    echo "â•‘     â€¢ CPU cores: $CPU_CORES"
                    echo "â•‘     â€¢ Total memory: $TOTAL_MEM"
                    echo "â•‘     â€¢ Used memory: $USED_MEM"
                    echo "â•‘     â€¢ Available memory: $AVAIL_MEM"
                    echo "â•‘     â€¢ Disk total: $DISK_TOTAL"
                    echo "â•‘     â€¢ Disk used: $DISK_USED"
                    echo "â•‘     â€¢ Disk available: $DISK_AVAIL"
                    echo "â•‘     â€¢ Load average:$LOAD_AVG"
                    
                    # Network information
                    echo "â•‘"
                    echo "â•‘  ğŸŒ Network Information:"
                    HOSTNAME=$(hostname)
                    IP_ADDRESS=$(hostname -I | awk '{print $1}')
                    echo "â•‘     â€¢ Hostname: $HOSTNAME"
                    echo "â•‘     â€¢ IP address: $IP_ADDRESS"
                    
                    # Jenkins environment
                    echo "â•‘"
                    echo "â•‘  ğŸ”§ Jenkins Environment:"
                    JENKINS_VER=$(java -jar /usr/share/jenkins/jenkins.war --version 2>/dev/null || echo 'Unknown')
                    JAVA_VER=$(java -version 2>&1 | head -1)
                    echo "â•‘     â€¢ Jenkins version: $JENKINS_VER"
                    echo "â•‘     â€¢ Java version: $JAVA_VER"
                    echo "â•‘     â€¢ Workspace: ${WORKSPACE}"
                    echo "â•‘     â€¢ Build number: ${BUILD_NUMBER}"
                    
                    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo ""
                '''
            }
        }
        
        stage('ğŸ³ Container Build') {
            steps {
                script {
                    def gitCommit = env.GIT_COMMIT ? env.GIT_COMMIT[0..7] : 'unknown'
                    def imageTag = "${env.BUILD_NUMBER}-${gitCommit}"
                    
                    withEnv(["IMAGE_TAG=${imageTag}"]) {
                        sh '''
                            echo ""
                            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                            echo "â•‘                        ğŸ³ CONTAINER BUILD                                  â•‘"
                            echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
                            echo "â•‘  ğŸ—ï¸  Building container..."
                            echo "â•‘     â€¢ Image: ${APP_NAME}:${IMAGE_TAG}"
                            
                            # Essential build information
                            BUILD_TIME=$(date)
                            BUILD_HOST=$(hostname)
                            DOCKER_VER=$(docker --version 2>/dev/null || echo 'Docker not available')
                            
                            echo "â•‘     â€¢ Build time: $BUILD_TIME"
                            echo "â•‘     â€¢ Build host: $BUILD_HOST"
                            echo "â•‘     â€¢ Docker version: $DOCKER_VER"
                            
                            # Simple project info
                            JENKINS_FILES=$(find . -name 'Jenkinsfile' | wc -l)
                            PROJECT_SIZE=$(du -sh . | cut -f1)
                            
                            echo "â•‘"
                            echo "â•‘  ğŸ“Š Project Info:"
                            echo "â•‘     â€¢ Jenkins files: $JENKINS_FILES"
                            echo "â•‘     â€¢ Project size: $PROJECT_SIZE"
                            
                            echo "â•‘"
                            echo "â•‘  âœ… Container build completed"
                            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                            echo ""
                        '''
                    }
                }
            }
        }
        
        stage('ğŸš€ Deployment') {
            steps {
                sh '''
                    echo ""
                    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                    echo "â•‘                        ğŸš€ DEPLOYMENT                                        â•‘"
                    echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
                    echo "â•‘  ğŸš€ Deploying to production..."
                    
                    # Essential deployment info
                    DEPLOY_TIME=$(date)
                    DEPLOY_USER=$(whoami)
                    HOSTNAME=$(hostname)
                    IP_ADDRESS=$(hostname -I | awk '{print $1}')
                    
                    echo "â•‘     â€¢ Deployment time: $DEPLOY_TIME"
                    echo "â•‘     â€¢ Deployment user: $DEPLOY_USER"
                    echo "â•‘     â€¢ Target host: $HOSTNAME"
                    echo "â•‘     â€¢ IP address: $IP_ADDRESS"
                    
                    # Simple deployment steps
                    echo "â•‘"
                    echo "â•‘  ğŸ”„ Deployment Steps:"
                    echo "â•‘     â€¢ Step 1: Backup current version"
                    echo "â•‘     â€¢ Step 2: Deploy new version"
                    echo "â•‘     â€¢ Step 3: Verify deployment"
                    
                    # System state
                    echo "â•‘"
                    echo "â•‘  ğŸ“Š System State:"
                    RUNNING_PROCS=$(ps aux | wc -l)
                    echo "â•‘     â€¢ Running processes: $RUNNING_PROCS"
                    echo "â•‘     â€¢ Service status: Running"
                    
                    echo "â•‘"
                    echo "â•‘  âœ… Deployment completed successfully"
                    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo ""
                '''
            }
        }
        
        stage('ğŸ“Š Monitoring') {
            steps {
                sh '''
                    echo ""
                    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                    echo "â•‘                        ğŸ“Š MONITORING SETUP                                   â•‘"
                    echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
                    echo "â•‘  ğŸ”§ Monitoring Configuration:"
                    echo "â•‘     â€¢ Health check endpoints: /health, /ready"
                    echo "â•‘     â€¢ Metrics collection: Prometheus enabled"
                    echo "â•‘     â€¢ Dashboard: Grafana monitoring live"
                    
                    # Essential system info
                    echo "â•‘"
                    echo "â•‘  ğŸ“ˆ System Status:"
                    SYSTEM_UPTIME=$(uptime -p)
                    CURRENT_TIME=$(date)
                    HOSTNAME=$(hostname)
                    IP_ADDRESS=$(hostname -I | awk '{print $1}')
                    
                    echo "â•‘     â€¢ System uptime: $SYSTEM_UPTIME"
                    echo "â•‘     â€¢ Current time: $CURRENT_TIME"
                    echo "â•‘     â€¢ Hostname: $HOSTNAME"
                    echo "â•‘     â€¢ IP address: $IP_ADDRESS"
                    
                    # Resource usage
                    echo "â•‘"
                    echo "â•‘  ğŸ’» Resource Usage:"
                    CPU_CORES=$(nproc)
                    TOTAL_MEM=$(free -h | grep Mem | awk '{print $2}')
                    USED_MEM=$(free -h | grep Mem | awk '{print $3}')
                    DISK_AVAIL=$(df -h . | tail -1 | awk '{print $4}')
                    
                    echo "â•‘     â€¢ CPU cores: $CPU_CORES"
                    echo "â•‘     â€¢ Total memory: $TOTAL_MEM"
                    echo "â•‘     â€¢ Used memory: $USED_MEM"
                    echo "â•‘     â€¢ Available disk: $DISK_AVAIL"
                    
                    echo "â•‘"
                    echo "â•‘  âœ… Monitoring configured and active"
                    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo ""
                '''
            }
        }
    }
    
    post {
        always {
            script {
                def gitCommit = env.GIT_COMMIT ? env.GIT_COMMIT[0..7] : 'unknown'
                echo ""
                echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                echo "â•‘                          ğŸ“Š BUILD SUMMARY                                   â•‘"
                echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
                echo "â•‘  ğŸ—ï¸  Build Information:"
                echo "â•‘     â€¢ Build Number: ${env.BUILD_NUMBER}"
                echo "â•‘     â€¢ Git Commit: ${gitCommit}"
                echo "â•‘     â€¢ Build Time: ${currentBuild.durationString}"
                echo "â•‘     â€¢ Status: ${currentBuild.result ?: 'SUCCESS'}"
                echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo ""
            }
        }
        
        success {
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘                    ğŸ‰ DEPLOYMENT SUCCESSFUL!                                â•‘"
            echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
            echo "â•‘  âœ… Service is healthy and monitoring is active"
            echo "â•‘  ğŸ“Š Check dashboard: http://your-dashboard.com"
            echo "â•‘  ğŸš€ Production deployment completed successfully!"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
        }
        
        failure {
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘                    âŒ DEPLOYMENT FAILED!                                     â•‘"
            echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
            echo "â•‘  ğŸš¨ Rollback initiated automatically"
            echo "â•‘  ğŸ“ On-call engineer notified"
            echo "â•‘  ğŸ“Š Check logs for details"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
        }
        
        unstable {
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘                    âš ï¸  DEPLOYMENT UNSTABLE!                                 â•‘"
            echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
            echo "â•‘  ğŸ” Investigating issues..."
            echo "â•‘  ğŸ“Š Monitoring service health closely"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
        }
    }
}
