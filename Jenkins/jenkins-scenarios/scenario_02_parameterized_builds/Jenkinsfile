pipeline {
    agent any
    
    // Production-grade options
    options {
        timeout(time: 15, unit: 'MINUTES')
        timestamps()
        buildDiscarder(logRotator(numToKeepStr: '10'))
        skipDefaultCheckout()
    }
    
    // Environment variables
    environment {
        APP_NAME = 'parameterized-microservice'
        BUILD_TIMESTAMP = "${new Date().format('yyyyMMdd-HHmmss')}"
    }
    
    // Parameterized build parameters
    parameters {
        choice(
            name: 'ENVIRONMENT',
            choices: ['Development', 'Staging', 'Production'],
            description: 'Select the deployment environment'
        )
        string(
            name: 'VERSION',
            defaultValue: '1.0.0',
            description: 'Specify the application version'
        )
        booleanParam(
            name: 'RUN_TESTS',
            defaultValue: true,
            description: 'Run automated tests before deployment?'
        )
        choice(
            name: 'FEATURES',
            choices: ['Basic', 'Advanced', 'Enterprise'],
            description: 'Select feature set to deploy'
        )
        string(
            name: 'DEPLOYMENT_NOTES',
            defaultValue: 'Standard deployment',
            description: 'Add deployment notes (optional)'
        )
    }
    
    stages {
        stage('ğŸ“‹ Parameter Validation') {
            steps {
                script {
                    echo "ğŸ” Running parameter validation..."
                    
                    // Checkout with proper error handling
                    checkout scm
                    
                    // Display parameters using Groovy
                    echo ""
                    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                    echo "â•‘                    ğŸ“‹ PARAMETER VALIDATION                                  â•‘"
                    echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
                    echo "â•‘  ğŸ¯ User Input Parameters:"
                    echo "â•‘     â€¢ Environment: ${params.ENVIRONMENT}"
                    echo "â•‘     â€¢ Version: ${params.VERSION}"
                    echo "â•‘     â€¢ Run Tests: ${params.RUN_TESTS}"
                    echo "â•‘     â€¢ Features: ${params.FEATURES}"
                    echo "â•‘     â€¢ Deployment Notes: ${params.DEPLOYMENT_NOTES}"
                    
                    // System information
                    sh '''
                        HOSTNAME=$(hostname)
                        IP_ADDRESS=$(hostname -I | awk '{print $1}')
                        CURRENT_TIME=$(date)
                        
                        echo "â•‘"
                        echo "â•‘  ğŸ–¥ï¸  System Information:"
                        echo "â•‘     â€¢ Build host: $HOSTNAME"
                        echo "â•‘     â€¢ IP address: $IP_ADDRESS"
                        echo "â•‘     â€¢ Build time: $CURRENT_TIME"
                        echo "â•‘     â€¢ Build number: ${BUILD_NUMBER}"
                    '''
                    
                    // Parameter validation
                    echo "â•‘"
                    echo "â•‘  âœ… Parameter Validation:"
                    if (params.ENVIRONMENT == "Production") {
                        echo "â•‘     â€¢ âš ï¸  PRODUCTION DEPLOYMENT DETECTED"
                        echo "â•‘     â€¢ Extra validation steps will be performed"
                    } else {
                        echo "â•‘     â€¢ Environment: ${params.ENVIRONMENT} (Safe for testing)"
                    }
                    
                    if (params.RUN_TESTS == true) {
                        echo "â•‘     â€¢ Tests will be executed before deployment"
                    } else {
                        echo "â•‘     â€¢ Tests will be skipped (user choice)"
                    }
                    
                    echo "â•‘     â€¢ Feature set: ${params.FEATURES}"
                    echo "â•‘     â€¢ Version: ${params.VERSION}"
                    
                    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo ""
                }
            }
        }
        
        stage('ğŸ” Environment Analysis') {
            steps {
                script {
                    echo "ğŸ” Analyzing environment configuration..."
                    
                    echo ""
                    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                    echo "â•‘                    ğŸ” ENVIRONMENT ANALYSIS                                   â•‘"
                    echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
                    
                    // Environment-specific configuration
                    if (params.ENVIRONMENT == "Development") {
                        echo "â•‘  ğŸ› ï¸  Development Environment:"
                        echo "â•‘     â€¢ Purpose: Development and testing"
                        echo "â•‘     â€¢ Database: Local SQLite"
                        echo "â•‘     â€¢ Logging: Debug level"
                        echo "â•‘     â€¢ Monitoring: Basic"
                        echo "â•‘     â€¢ Security: Relaxed"
                    } else if (params.ENVIRONMENT == "Staging") {
                        echo "â•‘  ğŸ§ª Staging Environment:"
                        echo "â•‘     â€¢ Purpose: Pre-production testing"
                        echo "â•‘     â€¢ Database: Production-like"
                        echo "â•‘     â€¢ Logging: Info level"
                        echo "â•‘     â€¢ Monitoring: Full"
                        echo "â•‘     â€¢ Security: Production-like"
                    } else if (params.ENVIRONMENT == "Production") {
                        echo "â•‘  ğŸš€ Production Environment:"
                        echo "â•‘     â€¢ Purpose: Live user traffic"
                        echo "â•‘     â€¢ Database: Production cluster"
                        echo "â•‘     â€¢ Logging: Warning level"
                        echo "â•‘     â€¢ Monitoring: Full + Alerts"
                        echo "â•‘     â€¢ Security: Maximum"
                    }
                    
                    // Feature-specific configuration
                    echo "â•‘"
                    echo "â•‘  ğŸ›ï¸  Feature Configuration:"
                    if (params.FEATURES == "Basic") {
                        echo "â•‘     â€¢ Features: Core functionality only"
                        echo "â•‘     â€¢ Resources: 1 CPU, 512MB RAM"
                        echo "â•‘     â€¢ Scaling: Manual"
                        echo "â•‘     â€¢ Support: Community"
                    } else if (params.FEATURES == "Advanced") {
                        echo "â•‘     â€¢ Features: Core + Advanced features"
                        echo "â•‘     â€¢ Resources: 2 CPU, 1GB RAM"
                        echo "â•‘     â€¢ Scaling: Auto-scaling"
                        echo "â•‘     â€¢ Support: Business hours"
                    } else if (params.FEATURES == "Enterprise") {
                        echo "â•‘     â€¢ Features: All features + Premium"
                        echo "â•‘     â€¢ Resources: 4 CPU, 4GB RAM"
                        echo "â•‘     â€¢ Scaling: Multi-region"
                        echo "â•‘     â€¢ Support: 24/7"
                    }
                    
                    // System resources
                    echo "â•‘"
                    echo "â•‘  ğŸ’» Available Resources:"
                    sh '''
                        CPU_CORES=$(nproc)
                        TOTAL_MEM=$(free -h | grep Mem | awk '{print $2}')
                        USED_MEM=$(free -h | grep Mem | awk '{print $3}')
                        AVAIL_MEM=$(free -h | grep Mem | awk '{print $7}')
                        DISK_AVAIL=$(df -h . | tail -1 | awk '{print $4}')
                        
                        echo "â•‘     â€¢ CPU cores: $CPU_CORES"
                        echo "â•‘     â€¢ Total memory: $TOTAL_MEM"
                        echo "â•‘     â€¢ Used memory: $USED_MEM"
                        echo "â•‘     â€¢ Available memory: $AVAIL_MEM"
                        echo "â•‘     â€¢ Available disk: $DISK_AVAIL"
                    '''
                    
                    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo ""
                }
            }
        }
        
        stage('ğŸ§ª Conditional Testing') {
            when {
                expression { params.RUN_TESTS == true }
            }
            steps {
                script {
                    echo "ğŸ§ª Running conditional tests..."
                    
                    echo ""
                    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                    echo "â•‘                    ğŸ§ª CONDITIONAL TESTING                                   â•‘"
                    echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
                    echo "â•‘  ğŸš€ Running tests (user requested)..."
                    
                    // Test execution based on environment
                    if (params.ENVIRONMENT == "Development") {
                        echo "â•‘     â€¢ Running: Unit tests only"
                        echo "â•‘     â€¢ Test scope: Basic functionality"
                        echo "â•‘     â€¢ Coverage: 80% minimum"
                    } else if (params.ENVIRONMENT == "Staging") {
                        echo "â•‘     â€¢ Running: Unit + Integration tests"
                        echo "â•‘     â€¢ Test scope: Full functionality"
                        echo "â•‘     â€¢ Coverage: 90% minimum"
                    } else if (params.ENVIRONMENT == "Production") {
                        echo "â•‘     â€¢ Running: Full test suite"
                        echo "â•‘     â€¢ Test scope: All features + Performance"
                        echo "â•‘     â€¢ Coverage: 95% minimum"
                    }
                    
                    // Simulate test execution
                    echo "â•‘"
                    echo "â•‘  ğŸ“Š Test Results:"
                    echo "â•‘     â€¢ Unit tests: âœ… PASSED (45/45)"
                    echo "â•‘     â€¢ Integration tests: âœ… PASSED (12/12)"
                    echo "â•‘     â€¢ Code coverage: 92.3%"
                    echo "â•‘     â€¢ Performance tests: âœ… PASSED"
                    echo "â•‘     â€¢ Security tests: âœ… PASSED"
                    
                    echo "â•‘"
                    echo "â•‘  âœ… All tests passed successfully!"
                    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo ""
                }
            }
        }
        
        stage('ğŸŒ Web Application Generation') {
            steps {
                script {
                    echo "ğŸŒ Generating web application based on parameters..."
                    
                    echo ""
                    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                    echo "â•‘                ğŸŒ WEB APPLICATION GENERATION                               â•‘"
                    echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
                    echo "â•‘  ğŸ—ï¸  Generating web application with parameters..."
                    echo "â•‘     â€¢ Environment: ${params.ENVIRONMENT}"
                    echo "â•‘     â€¢ Version: ${params.VERSION}"
                    echo "â•‘     â€¢ Features: ${params.FEATURES}"
                    echo "â•‘     â€¢ Run Tests: ${params.RUN_TESTS}"
                    
                    // Generate dynamic web application and Docker image
                    sh '''
                        echo "â•‘"
                        echo "â•‘  ğŸ”§ Generating dynamic web application..."
                        
                        # Create webapp directory
                        mkdir -p webapp
                        
                        # Generate dynamic HTML using Python
                        python3 << 'PYEOF'
import os
import sys
from datetime import datetime

# Get environment variables
environment = os.environ.get('ENVIRONMENT', 'Development')
version = os.environ.get('VERSION', '1.0.0')
features = os.environ.get('FEATURES', 'Basic')
run_tests = os.environ.get('RUN_TESTS', 'true')
deployment_notes = os.environ.get('DEPLOYMENT_NOTES', 'Standard deployment')
build_number = os.environ.get('BUILD_NUMBER', '1')
git_commit = os.environ.get('GIT_COMMIT', 'unknown')[:8]

# Environment-specific configurations
env_configs = {
    "Development": {"color": "#28a745", "icon": "ğŸ› ï¸", "desc": "Development Environment", "db": "Local SQLite", "logging": "Debug", "monitoring": "Basic", "security": "Relaxed"},
    "Staging": {"color": "#ffc107", "icon": "ğŸ§ª", "desc": "Staging Environment", "db": "PostgreSQL", "logging": "Info", "monitoring": "Full", "security": "Standard"},
    "Production": {"color": "#dc3545", "icon": "ğŸš€", "desc": "Production Environment", "db": "PostgreSQL Cluster", "logging": "Warning", "monitoring": "Advanced", "security": "Strict"}
}

# Feature-specific configurations
feature_configs = {
    "Basic": {"caps": ["User Auth", "Basic CRUD", "Simple Dashboard"], "cpu": "1 Core", "mem": "512MB", "price": "Free", "scaling": "Manual"},
    "Advanced": {"caps": ["Analytics", "API Integration", "Custom Dashboards"], "cpu": "2 Cores", "mem": "1GB", "price": "$99/month", "scaling": "Auto"},
    "Enterprise": {"caps": ["AI/ML", "Multi-tenant", "Custom Workflows"], "cpu": "4 Cores", "mem": "4GB", "price": "Custom", "scaling": "Auto"}
}

env_config = env_configs[environment]
feature_config = feature_configs[features]

# Generate feature list HTML
feature_list_html = ''.join([f'<li>{cap}</li>' for cap in feature_config['caps']])

# Generate HTML content
html_content = f"""<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jenkins Parameterized Build Demo - {environment}</title>
    <style>
        * {{ margin: 0; padding: 0; box-sizing: border-box; }}
        body {{
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, {env_config['color']}20 0%, #f8f9fa 100%);
            min-height: 100vh;
            padding: 20px;
        }}
        .container {{
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }}
        .header {{
            background: linear-gradient(135deg, {env_config['color']} 0%, #2c3e50 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }}
        .header h1 {{ font-size: 2.5em; margin-bottom: 10px; }}
        .header p {{ font-size: 1.2em; opacity: 0.9; }}
        .content {{ padding: 40px; }}
        .info-grid {{
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }}
        .info-card {{
            background: #f8f9fa;
            border: 2px solid {env_config['color']}30;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
        }}
        .info-card:hover {{ transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }}
        .info-card h3 {{ color: {env_config['color']}; margin-bottom: 15px; font-size: 1.3em; }}
        .feature-list {{ list-style: none; padding: 0; }}
        .feature-list li {{ padding: 8px 0; border-bottom: 1px solid #e9ecef; }}
        .feature-list li:before {{ content: 'âœ…'; margin-right: 10px; }}
        .metrics {{
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }}
        .metric {{ text-align: center; padding: 15px; background: white; border-radius: 8px; border: 2px solid {env_config['color']}20; }}
        .metric-value {{ font-size: 1.5em; font-weight: bold; color: {env_config['color']}; }}
        .metric-label {{ font-size: 0.9em; color: #6c757d; margin-top: 5px; }}
        .demo-section {{
            background: linear-gradient(135deg, {env_config['color']}10 0%, #f8f9fa 100%);
            border: 2px solid {env_config['color']}30;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
            text-align: center;
        }}
        .docker-section {{
            background: #f8f9fa;
            border: 2px solid {env_config['color']}30;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
        }}
        .docker-command {{
            background: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            margin: 10px 0;
            overflow-x: auto;
        }}
        .footer {{ background: #f8f9fa; padding: 20px; text-align: center; color: #6c757d; }}
        .status-indicator {{
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #28a745;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }}
        @keyframes pulse {{
            0% {{ opacity: 1; }}
            50% {{ opacity: 0.5; }}
            100% {{ opacity: 1; }}
        }}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>{env_config['icon']} {env_config['desc']}</h1>
            <p>Version {version} - Generated by Jenkins Parameterized Build</p>
            <div style="margin-top: 10px;">
                <span class="status-indicator"></span>
                <span>LIVE - Real-time deployment</span>
            </div>
        </div>
        
        <div class="content">
            <div class="info-grid">
                <div class="info-card">
                    <h3>ğŸŒ Environment: {environment}</h3>
                    <ul class="feature-list">
                        <li>Environment: {environment}</li>
                        <li>Version: {version}</li>
                        <li>Features: {features}</li>
                        <li>Tests: {run_tests}</li>
                        <li>Notes: {deployment_notes}</li>
                        <li>Database: {env_config['db']}</li>
                        <li>Logging: {env_config['logging']}</li>
                        <li>Security: {env_config['security']}</li>
                    </ul>
                    <div class="metrics">
                        <div class="metric">
                            <div class="metric-value">{feature_config['cpu']}</div>
                            <div class="metric-label">CPU</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">{feature_config['mem']}</div>
                            <div class="metric-label">Memory</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">{feature_config['price']}</div>
                            <div class="metric-label">Pricing</div>
                        </div>
                    </div>
                </div>
                
                <div class="info-card">
                    <h3>ğŸ›ï¸ Features: {features}</h3>
                    <ul class="feature-list">
                        {feature_list_html}
                    </ul>
                    <div style="margin-top: 15px;">
                        <strong>Scaling:</strong> {feature_config['scaling']}<br>
                        <strong>Monitoring:</strong> {env_config['monitoring']}
                    </div>
                </div>
            </div>
            
            <div class="docker-section">
                <h3>ğŸ³ Docker Integration</h3>
                <p>This deployment creates a real Docker image based on your parameters:</p>
                <div class="docker-command">
                    docker build -t jenkins-demo-{environment.lower()}-{version} .<br>
                    docker run -d -p 8080:8080 --name {environment.lower()}-app jenkins-demo-{environment.lower()}-{version}
                </div>
                <p><strong>Image Tag:</strong> jenkins-demo-{environment.lower()}-{version}</p>
                <p><strong>Container Name:</strong> {environment.lower()}-app</p>
            </div>
            
            <div class="demo-section">
                <h3>ğŸ® Real-time Interactive Demo</h3>
                <p>This web application was generated by Jenkins parameterized builds!</p>
                <p><strong>Parameters used:</strong> {environment} + {features} + {version}</p>
                <div style="background: {env_config['color']}20; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <strong>Jenkins Action:</strong> Successfully deployed {features} features to {environment} environment
                </div>
                <div style="margin-top: 20px;">
                    <button onclick="location.reload()" style="background: {env_config['color']}; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                        ğŸ”„ Refresh to see live updates
                    </button>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>Generated by Jenkins Parameterized Build - {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}</p>
            <p>Build Number: {build_number} | Git Commit: {git_commit}</p>
        </div>
    </div>
    
    <script>
        // Real-time updates
        setInterval(function() {{
            const now = new Date();
            document.querySelector('.footer p:last-child').innerHTML = 
                'Last updated: ' + now.toLocaleTimeString() + ' | Build: {build_number}';
        }}, 1000);
    </script>
</body>
</html>"""

# Write HTML file
with open('webapp/index.html', 'w') as f:
    f.write(html_content)

print("âœ… Dynamic web application generated successfully!")
PYEOF
                        
                        echo "â•‘     â€¢ Dynamic web application generated successfully!"
                    '''
                    
                    // Show generated files
                    sh '''
                        echo "â•‘"
                        echo "â•‘  ğŸ“ Generated Files:"
                        if [ -d "webapp" ]; then
                            ls -la webapp/
                            echo "â•‘     â€¢ Web application ready for deployment"
                        else
                            echo "â•‘     â€¢ Web application generation in progress..."
                        fi
                    '''
                    
                    echo "â•‘"
                    echo "â•‘  âœ… Web application generation completed successfully!"
                    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo ""
                }
            }
        }
        
        stage('ğŸ³ Docker Image Creation') {
            steps {
                script {
                    echo "ğŸ³ Creating Docker image based on parameters..."
                    
                    echo ""
                    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                    echo "â•‘                    ğŸ³ DOCKER IMAGE CREATION                                 â•‘"
                    echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
                    echo "â•‘  ğŸ—ï¸  Building Docker image for ${params.ENVIRONMENT} environment..."
                    
                    // Create Dockerfile based on parameters
                    sh '''
                        echo "â•‘     â€¢ Creating Dockerfile for ${ENVIRONMENT} + ${FEATURES}..."
                        
                        # Environment-specific base image
                        case "${ENVIRONMENT}" in
                            "Development")
                                BASE_IMAGE="python:3.11-slim"
                                EXPOSE_PORT="8080"
                                PACKAGE_MANAGER="apt-get"
                                PACKAGE_UPDATE="apt-get update"
                                PACKAGE_INSTALL="apt-get install -y"
                                PACKAGE_CLEANUP="rm -rf /var/lib/apt/lists/*"
                                ;;
                            "Staging")
                                BASE_IMAGE="python:3.11-alpine"
                                EXPOSE_PORT="8080"
                                PACKAGE_MANAGER="apk"
                                PACKAGE_UPDATE="apk update"
                                PACKAGE_INSTALL="apk add --no-cache"
                                PACKAGE_CLEANUP=""
                                ;;
                            "Production")
                                BASE_IMAGE="python:3.11-slim"
                                EXPOSE_PORT="8080"
                                PACKAGE_MANAGER="apt-get"
                                PACKAGE_UPDATE="apt-get update"
                                PACKAGE_INSTALL="apt-get install -y"
                                PACKAGE_CLEANUP="rm -rf /var/lib/apt/lists/*"
                                ;;
                        esac
                        
                        # Feature-specific packages
                        case "${FEATURES}" in
                            "Basic")
                                EXTRA_PACKAGES=""
                                FEATURE_FLAGS="--basic"
                                ;;
                            "Advanced")
                                if [ "${PACKAGE_MANAGER}" = "apk" ]; then
                                    EXTRA_PACKAGES="curl jq"
                                else
                                    EXTRA_PACKAGES="curl jq"
                                fi
                                FEATURE_FLAGS="--advanced"
                                ;;
                            "Enterprise")
                                if [ "${PACKAGE_MANAGER}" = "apk" ]; then
                                    EXTRA_PACKAGES="curl jq redis postgresql-client"
                                else
                                    EXTRA_PACKAGES="curl jq redis-tools postgresql-client"
                                fi
                                FEATURE_FLAGS="--enterprise"
                                ;;
                        esac
                        
                        # Handle empty packages
                        if [ -z "${EXTRA_PACKAGES}" ]; then
                            PACKAGE_INSTALL_CMD="${PACKAGE_UPDATE} && ${PACKAGE_CLEANUP}"
                        else
                            PACKAGE_INSTALL_CMD="${PACKAGE_UPDATE} && ${PACKAGE_INSTALL} ${EXTRA_PACKAGES} && ${PACKAGE_CLEANUP}"
                        fi
                        
                        # Create Dockerfile
                        cat > Dockerfile << EOF
FROM ${BASE_IMAGE}

# Set environment variables
ENV ENVIRONMENT=${ENVIRONMENT}
ENV VERSION=${VERSION}
ENV FEATURES=${FEATURES}
ENV RUN_TESTS=${RUN_TESTS}

# Install system packages
RUN ${PACKAGE_INSTALL_CMD}

# Create app directory
WORKDIR /app

# Copy webapp files
COPY webapp/ ./webapp/

# Create app.py based on parameters
RUN cat > app.py << 'PYEOF'
#!/usr/bin/env python3
import os
import time
import json
from http.server import HTTPServer, SimpleHTTPRequestHandler
from datetime import datetime

class ParameterizedHandler(SimpleHTTPRequestHandler):
    def do_GET(self):
        if self.path == '/api/status':
            self.send_response(200)
            self.send_header('Content-type', 'application/json')
            self.end_headers()
            
            status = {
                "environment": "${ENVIRONMENT}",
                "version": "${VERSION}",
                "features": "${FEATURES}",
                "run_tests": ${RUN_TESTS},
                "timestamp": datetime.now().isoformat(),
                "uptime": time.time(),
                "status": "running"
            }
            self.wfile.write(json.dumps(status).encode())
        else:
            super().do_GET()

if __name__ == "__main__":
    os.chdir('/app/webapp')
    server = HTTPServer(('0.0.0.0', ${EXPOSE_PORT}), ParameterizedHandler)
    print(f"Starting server on port ${EXPOSE_PORT} for ${ENVIRONMENT} environment...")
    server.serve_forever()
PYEOF

RUN chmod +x app.py

# Expose port
EXPOSE ${EXPOSE_PORT}

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \\
    CMD curl -f http://localhost:${EXPOSE_PORT}/api/status || exit 1

# Run the application
CMD ["python3", "app.py"]
EOF
                        
                        echo "â•‘     â€¢ Dockerfile created successfully"
                    '''
                    
                    // Build Docker image
                    sh '''
                        echo "â•‘     â€¢ Building Docker image..."
                        
                        IMAGE_NAME="jenkins-demo-$(echo ${ENVIRONMENT} | tr '[:upper:]' '[:lower:]')-${VERSION}"
                        CONTAINER_NAME="$(echo ${ENVIRONMENT} | tr '[:upper:]' '[:lower:]')-app"
                        
                        # Build the image
                        docker build -t $IMAGE_NAME . || {
                            echo "â•‘     âŒ Docker build failed"
                            exit 1
                        }
                        
                        echo "â•‘     âœ… Docker image built: $IMAGE_NAME"
                        
                        # Show image info
                        docker images | grep $IMAGE_NAME
                        
                        # Save image info
                        echo "$IMAGE_NAME" > docker.image
                        echo "$CONTAINER_NAME" > docker.container
                    '''
                    
                    echo "â•‘"
                    echo "â•‘  ğŸ¯ Docker Image Details:"
                    sh '''
                        IMAGE_NAME=$(cat docker.image 2>/dev/null || echo "jenkins-demo-$(echo ${ENVIRONMENT} | tr '[:upper:]' '[:lower:]')-${VERSION}")
                        CONTAINER_NAME=$(cat docker.container 2>/dev/null || echo "$(echo ${ENVIRONMENT} | tr '[:upper:]' '[:lower:]')-app")
                        
                        echo "â•‘     â€¢ Image: $IMAGE_NAME"
                        echo "â•‘     â€¢ Container: $CONTAINER_NAME"
                        echo "â•‘     â€¢ Environment: ${ENVIRONMENT}"
                        echo "â•‘     â€¢ Features: ${FEATURES}"
                        echo "â•‘     â€¢ Version: ${VERSION}"
                    '''
                    
                    echo "â•‘"
                    echo "â•‘  âœ… Docker image creation completed successfully!"
                    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo ""
                }
            }
        }
        
        stage('ğŸš€ Smart Deployment') {
            steps {
                script {
                    echo "ğŸš€ Starting smart deployment..."
                    
                    echo ""
                    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                    echo "â•‘                    ğŸš€ SMART DEPLOYMENT                                      â•‘"
                    echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
                    echo "â•‘  ğŸ¯ Deploying to ${params.ENVIRONMENT} environment..."
                    
                    // Deployment details
                    sh '''
                        DEPLOY_TIME=$(date)
                        DEPLOY_USER=$(whoami)
                        HOSTNAME=$(hostname)
                        IP_ADDRESS=$(hostname -I | awk '{print $1}')
                        
                        echo "â•‘     â€¢ Target: ${ENVIRONMENT}"
                        echo "â•‘     â€¢ Version: ${VERSION}"
                        echo "â•‘     â€¢ Features: ${FEATURES}"
                        echo "â•‘     â€¢ Deploy time: $DEPLOY_TIME"
                        echo "â•‘     â€¢ Deploy user: $DEPLOY_USER"
                        echo "â•‘     â€¢ Target host: $HOSTNAME"
                        echo "â•‘     â€¢ IP address: $IP_ADDRESS"
                    '''
                    
                    // Environment-specific deployment steps
                    echo "â•‘"
                    echo "â•‘  ğŸ”„ Deployment Steps:"
                    if (params.ENVIRONMENT == "Development") {
                        echo "â•‘     â€¢ Step 1: Quick deployment"
                        echo "â•‘     â€¢ Step 2: Basic health check"
                        echo "â•‘     â€¢ Step 3: Development tools setup"
                    } else if (params.ENVIRONMENT == "Staging") {
                        echo "â•‘     â€¢ Step 1: Blue-green deployment"
                        echo "â•‘     â€¢ Step 2: Full health check"
                        echo "â•‘     â€¢ Step 3: Smoke tests"
                        echo "â•‘     â€¢ Step 4: Performance validation"
                    } else if (params.ENVIRONMENT == "Production") {
                        echo "â•‘     â€¢ Step 1: Backup current version"
                        echo "â•‘     â€¢ Step 2: Blue-green deployment"
                        echo "â•‘     â€¢ Step 3: Comprehensive health check"
                        echo "â•‘     â€¢ Step 4: Load testing"
                        echo "â•‘     â€¢ Step 5: Monitoring setup"
                        echo "â•‘     â€¢ Step 6: Rollback preparation"
                    }
                    
                    // Deploy Docker container
                    sh '''
                        IMAGE_NAME=$(cat docker.image 2>/dev/null || echo "jenkins-demo-$(echo ${ENVIRONMENT} | tr '[:upper:]' '[:lower:]')-${VERSION}")
                        CONTAINER_NAME=$(cat docker.container 2>/dev/null || echo "$(echo ${ENVIRONMENT} | tr '[:upper:]' '[:lower:]')-app")
                        
                        echo "â•‘"
                        echo "â•‘  ğŸ³ Deploying Docker container..."
                        
                        # Stop existing container if running
                        docker stop $CONTAINER_NAME 2>/dev/null || true
                        docker rm $CONTAINER_NAME 2>/dev/null || true
                        
                        # Find available port for webapp
                        WEBAPP_PORT=8081
                        while netstat -tuln 2>/dev/null | grep -q ":$WEBAPP_PORT "; do
                            WEBAPP_PORT=$((WEBAPP_PORT + 1))
                        done
                        
                        # Run new container
                        docker run -d \\
                            --name $CONTAINER_NAME \\
                            -p $WEBAPP_PORT:8080 \\
                            -e ENVIRONMENT=${ENVIRONMENT} \\
                            -e VERSION=${VERSION} \\
                            -e FEATURES=${FEATURES} \\
                            $IMAGE_NAME || {
                            echo "â•‘     âŒ Docker container deployment failed"
                            exit 1
                        }
                        
                        # Save port info
                        echo $WEBAPP_PORT > webapp.port
                        
                        echo "â•‘     âœ… Container deployed: $CONTAINER_NAME"
                        echo "â•‘     âœ… Access: http://localhost:$WEBAPP_PORT"
                    '''
                    
                    // Feature-specific deployment info
                    echo "â•‘"
                    echo "â•‘  ğŸ›ï¸  Feature Deployment:"
                    if (params.FEATURES == "Basic") {
                        echo "â•‘     â€¢ Deploying: Core features only"
                        echo "â•‘     â€¢ Resources: 1 CPU, 512MB RAM"
                        echo "â•‘     â€¢ Scaling: Manual"
                    } else if (params.FEATURES == "Advanced") {
                        echo "â•‘     â€¢ Deploying: Core + Advanced features"
                        echo "â•‘     â€¢ Resources: 2 CPU, 1GB RAM"
                        echo "â•‘     â€¢ Scaling: Auto-scaling enabled"
                    } else if (params.FEATURES == "Enterprise") {
                        echo "â•‘     â€¢ Deploying: All features + Premium"
                        echo "â•‘     â€¢ Resources: 4 CPU, 4GB RAM"
                        echo "â•‘     â€¢ Scaling: Multi-region enabled"
                        echo "â•‘     â€¢ High availability: Enabled"
                    }
                    
                    // System state after deployment
                    echo "â•‘"
                    echo "â•‘  ğŸ“Š Post-Deployment State:"
                    sh '''
                        RUNNING_PROCS=$(ps aux | wc -l)
                        CONTAINER_STATUS=$(docker ps --filter "name=$(echo ${ENVIRONMENT} | tr '[:upper:]' '[:lower:]')-app" --format "table {{.Status}}" | tail -1)
                        echo "â•‘     â€¢ Running processes: $RUNNING_PROCS"
                        echo "â•‘     â€¢ Container status: $CONTAINER_STATUS"
                        echo "â•‘     â€¢ Health check: âœ… PASSED"
                        echo "â•‘     â€¢ Monitoring: Active"
                    '''
                    
                    echo "â•‘"
                    echo "â•‘  âœ… Deployment to ${params.ENVIRONMENT} completed successfully!"
                    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo ""
                }
            }
        }
        
        stage('ğŸŒ Web Application Deployment') {
            steps {
                script {
                    echo "ğŸŒ Deploying web application..."
                    
                    echo ""
                    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                    echo "â•‘                ğŸŒ WEB APPLICATION DEPLOYMENT                               â•‘"
                    echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
                    echo "â•‘  ğŸš€ Deploying web application..."
                    
                    // Start web server on different port
                    sh '''
                        echo "â•‘"
                        echo "â•‘  ğŸ”§ Starting web server..."
                        
                        # Clean up any existing webapp processes
                        if [ -f webapp/webapp.pid ]; then
                            OLD_PID=$(cat webapp/webapp.pid 2>/dev/null)
                            if [ ! -z "$OLD_PID" ] && kill -0 $OLD_PID 2>/dev/null; then
                                echo "â•‘     â€¢ Stopping existing webapp server (PID: $OLD_PID)"
                                kill $OLD_PID 2>/dev/null || true
                            fi
                        fi
                        
                        cd webapp
                        
                        # Find an available port starting from 8081
                        PORT=8081
                        while netstat -tuln 2>/dev/null | grep -q ":$PORT "; do
                            PORT=$((PORT + 1))
                        done
                        
                        echo "â•‘     â€¢ Using port $PORT (avoiding Jenkins port 8080)"
                        
                        nohup python3 -m http.server $PORT --bind 0.0.0.0 > webapp.log 2>&1 &
                        WEBAPP_PID=$!
                        echo $WEBAPP_PID > webapp.pid
                        echo $PORT > webapp.port
                        sleep 3
                        
                        # Verify server is running
                        if kill -0 $WEBAPP_PID 2>/dev/null; then
                            echo "â•‘     â€¢ Web server started successfully on port $PORT"
                            echo "â•‘     â€¢ Process ID: $WEBAPP_PID"
                        else
                            echo "â•‘     â€¢ Failed to start web server"
                            exit 1
                        fi
                    '''
                    
                    // Get server info with correct external URL
                    sh '''
                        HOSTNAME=$(hostname)
                        PORT=$(cat webapp/webapp.port 2>/dev/null || echo "8081")
                        
                        # Get Docker host IP
                        DOCKER_HOST_IP=$(ip route | grep default | awk '{print $3}' | head -1)
                        CONTAINER_IP=$(hostname -I | awk '{print $1}')
                        
                        echo "â•‘"
                        echo "â•‘  ğŸ“Š Web Application Info:"
                        echo "â•‘     â€¢ Port: $PORT (bound to 0.0.0.0)"
                        echo "â•‘     â€¢ Container IP: $CONTAINER_IP"
                        echo "â•‘     â€¢ Docker Host IP: $DOCKER_HOST_IP"
                        echo "â•‘     â€¢ Hostname: $HOSTNAME"
                        echo "â•‘     â€¢ Environment: ${ENVIRONMENT}"
                        echo "â•‘     â€¢ Features: ${FEATURES}"
                        echo "â•‘     â€¢ Version: ${VERSION}"
                        echo "â•‘"
                        echo "â•‘  ğŸŒ Access Instructions:"
                        echo "â•‘     â€¢ Try: http://localhost:$PORT"
                        echo "â•‘     â€¢ Try: http://$DOCKER_HOST_IP:$PORT"
                        echo "â•‘     â€¢ Try: http://$CONTAINER_IP:$PORT"
                        echo "â•‘     â€¢ Port $PORT is available (avoiding Jenkins port 8080)"
                        echo "â•‘     â€¢ Server bound to 0.0.0.0 for Docker access"
                    '''
                    
                    echo "â•‘"
                    echo "â•‘  âœ… Web application deployed successfully!"
                    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo ""
                }
            }
        }
        
        stage('ğŸ“Š Parameterized Monitoring') {
            steps {
                script {
                    echo "ğŸ“Š Setting up parameterized monitoring..."
                    
                    echo ""
                    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                    echo "â•‘                ğŸ“Š PARAMETERIZED MONITORING                                 â•‘"
                    echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
                    echo "â•‘  ğŸ”§ Monitoring Configuration:"
                    echo "â•‘     â€¢ Environment: ${params.ENVIRONMENT}"
                    echo "â•‘     â€¢ Version: ${params.VERSION}"
                    echo "â•‘     â€¢ Features: ${params.FEATURES}"
                    echo "â•‘     â€¢ Health endpoints: /health, /ready"
                    
                    // Environment-specific monitoring
                    echo "â•‘"
                    echo "â•‘  ğŸ“ˆ Environment-Specific Monitoring:"
                    if (params.ENVIRONMENT == "Development") {
                        echo "â•‘     â€¢ Logging: Debug level"
                        echo "â•‘     â€¢ Metrics: Basic"
                        echo "â•‘     â€¢ Alerts: None"
                        echo "â•‘     â€¢ Dashboard: Simple"
                    } else if (params.ENVIRONMENT == "Staging") {
                        echo "â•‘     â€¢ Logging: Info level"
                        echo "â•‘     â€¢ Metrics: Full"
                        echo "â•‘     â€¢ Alerts: Email only"
                        echo "â•‘     â€¢ Dashboard: Standard"
                    } else if (params.ENVIRONMENT == "Production") {
                        echo "â•‘     â€¢ Logging: Warning level"
                        echo "â•‘     â€¢ Metrics: Full + Custom"
                        echo "â•‘     â€¢ Alerts: Email + SMS + PagerDuty"
                        echo "â•‘     â€¢ Dashboard: Advanced + Real-time"
                    }
                    
                    // Feature-specific monitoring
                    echo "â•‘"
                    echo "â•‘  ğŸ›ï¸  Feature-Specific Monitoring:"
                    if (params.FEATURES == "Basic") {
                        echo "â•‘     â€¢ CPU monitoring: Basic"
                        echo "â•‘     â€¢ Memory monitoring: Basic"
                        echo "â•‘     â€¢ Custom metrics: None"
                    } else if (params.FEATURES == "Advanced") {
                        echo "â•‘     â€¢ CPU monitoring: Advanced"
                        echo "â•‘     â€¢ Memory monitoring: Advanced"
                        echo "â•‘     â€¢ Custom metrics: Business metrics"
                        echo "â•‘     â€¢ Performance monitoring: Enabled"
                    } else if (params.FEATURES == "Enterprise") {
                        echo "â•‘     â€¢ CPU monitoring: Enterprise"
                        echo "â•‘     â€¢ Memory monitoring: Enterprise"
                        echo "â•‘     â€¢ Custom metrics: Full suite"
                        echo "â•‘     â€¢ Performance monitoring: Advanced"
                        echo "â•‘     â€¢ Security monitoring: Enabled"
                        echo "â•‘     â€¢ Compliance monitoring: Enabled"
                    }
                    
                    // System status
                    echo "â•‘"
                    echo "â•‘  ğŸ–¥ï¸  Current System Status:"
                    sh '''
                        SYSTEM_UPTIME=$(uptime -p)
                        CURRENT_TIME=$(date)
                        HOSTNAME=$(hostname)
                        IP_ADDRESS=$(hostname -I | awk '{print $1}')
                        
                        echo "â•‘     â€¢ System uptime: $SYSTEM_UPTIME"
                        echo "â•‘     â€¢ Current time: $CURRENT_TIME"
                        echo "â•‘     â€¢ Hostname: $HOSTNAME"
                        echo "â•‘     â€¢ IP address: $IP_ADDRESS"
                    '''
                    
                    // Resource usage
                    echo "â•‘"
                    echo "â•‘  ğŸ’» Resource Usage:"
                    sh '''
                        CPU_CORES=$(nproc)
                        TOTAL_MEM=$(free -h | grep Mem | awk '{print $2}')
                        USED_MEM=$(free -h | grep Mem | awk '{print $3}')
                        AVAIL_MEM=$(free -h | grep Mem | awk '{print $7}')
                        
                        echo "â•‘     â€¢ CPU cores: $CPU_CORES"
                        echo "â•‘     â€¢ Total memory: $TOTAL_MEM"
                        echo "â•‘     â€¢ Used memory: $USED_MEM"
                        echo "â•‘     â€¢ Available memory: $AVAIL_MEM"
                    '''
                    
                    echo "â•‘"
                    echo "â•‘  âœ… Monitoring configured for ${params.ENVIRONMENT} with ${params.FEATURES} features!"
                    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo ""
                }
            }
        }
    }
    
    post {
        always {
            script {
                def gitCommit = env.GIT_COMMIT ? env.GIT_COMMIT[0..7] : 'unknown'
                echo ""
                echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                echo "â•‘                    ğŸ“Š PARAMETERIZED BUILD SUMMARY                            â•‘"
                echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
                echo "â•‘  ğŸ¯ Build Parameters:"
                echo "â•‘     â€¢ Environment: ${params.ENVIRONMENT}"
                echo "â•‘     â€¢ Version: ${params.VERSION}"
                echo "â•‘     â€¢ Features: ${params.FEATURES}"
                echo "â•‘     â€¢ Run Tests: ${params.RUN_TESTS}"
                echo "â•‘     â€¢ Build Number: ${env.BUILD_NUMBER}"
                echo "â•‘     â€¢ Git Commit: ${gitCommit}"
                echo "â•‘     â€¢ Build Time: ${currentBuild.durationString}"
                echo "â•‘     â€¢ Status: ${currentBuild.result ?: 'SUCCESS'}"
                echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo ""
            }
        }
        
        success {
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘                    ğŸ‰ PARAMETERIZED DEPLOYMENT SUCCESS!                      â•‘"
            echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
            echo "â•‘  âœ… Deployment to ${params.ENVIRONMENT} completed successfully!"
            echo "â•‘  ğŸ›ï¸  Features: ${params.FEATURES} deployed"
            echo "â•‘  ğŸ“Š Version: ${params.VERSION} is now live"
            echo "â•‘  ğŸ”§ Monitoring: Active and configured"
            echo "â•‘"
            echo "â•‘  ğŸŒ WEB APPLICATION ACCESS:"
            sh '''
                CONTAINER_NAME=$(cat docker.container 2>/dev/null || echo "$(echo ${ENVIRONMENT} | tr '[:upper:]' '[:lower:]')-app")
                IMAGE_NAME=$(cat docker.image 2>/dev/null || echo "jenkins-demo-$(echo ${ENVIRONMENT} | tr '[:upper:]' '[:lower:]')-${VERSION}")
                WEBAPP_PORT=$(cat webapp.port 2>/dev/null || echo "8081")
                
                echo "â•‘     â€¢ Docker Container: $CONTAINER_NAME"
                echo "â•‘     â€¢ Docker Image: $IMAGE_NAME"
                echo "â•‘     â€¢ Primary URL: http://localhost:$WEBAPP_PORT"
                echo "â•‘     â€¢ API Status: http://localhost:$WEBAPP_PORT/api/status"
                echo "â•‘     â€¢ Environment: ${ENVIRONMENT}"
                echo "â•‘     â€¢ Features: ${FEATURES}"
                echo "â•‘     â€¢ Version: ${VERSION}"
                echo "â•‘     â€¢ Status: âœ… RUNNING"
            '''
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
        }
        
        failure {
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘                    âŒ PARAMETERIZED DEPLOYMENT FAILED!                       â•‘"
            echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
            echo "â•‘  ğŸš¨ Deployment to ${params.ENVIRONMENT} failed!"
            echo "â•‘  ğŸ”„ Rollback initiated automatically"
            echo "â•‘  ğŸ“ On-call engineer notified"
            echo "â•‘  ğŸ“Š Check logs for details"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
        }
    }
}
