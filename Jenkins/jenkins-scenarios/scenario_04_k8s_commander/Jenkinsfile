pipeline {
    agent any
    
    options {
        timeout(time: 20, unit: 'MINUTES')
        timestamps()
        retry(2)
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }
    
    parameters {
        choice(
            name: 'K8S_CONCEPT',
            choices: ['Pods', 'Services', 'Deployments', 'ConfigMaps', 'Secrets', 'Ingress', 'All Concepts'],
            description: 'Kubernetes concept to explore'
        )
        choice(
            name: 'LEARNING_LEVEL',
            choices: ['Beginner', 'Intermediate', 'Advanced'],
            description: 'Learning complexity level'
        )
        booleanParam(
            name: 'INTERACTIVE_DEMO',
            defaultValue: true,
            description: 'Enable interactive demonstrations'
        )
        booleanParam(
            name: 'HANDS_ON_LAB',
            defaultValue: true,
            description: 'Enable hands-on lab exercises'
        )
        string(
            name: 'NAMESPACE',
            defaultValue: 'k8s-learning',
            description: 'Kubernetes namespace for exercises'
        )
    }
    
    environment {
        K8S_VERSION = '1.28'
        DOCKER_REGISTRY = 'docker.io'
        LEARNING_PROGRESS = '0'
        ACHIEVEMENTS = ''
        CURRENT_CONCEPT = "${params.K8S_CONCEPT}"
        LEARNING_LEVEL = "${params.LEARNING_LEVEL}"
    }

    stages {
        stage('ğŸš€ K8s Commander Launch') {
            steps {
                script {
                    echo "ğŸš€ Welcome to K8s Commander - Your Kubernetes Learning Journey!"
                    echo ""
                    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                    echo "â•‘                        ğŸ¯ K8S COMMANDER LAUNCH                              â•‘"
                    echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
                    echo "â•‘  ğŸ“ Learning Journey: Jenkins â†’ Kubernetes Transition"
                    echo "â•‘  ğŸ“š Concept Focus: ${params.K8S_CONCEPT}"
                    echo "â•‘  ğŸ¯ Learning Level: ${params.LEARNING_LEVEL}"
                    echo "â•‘  ğŸ§ª Interactive Demo: ${params.INTERACTIVE_DEMO ? 'Enabled' : 'Disabled'}"
                    echo "â•‘  ğŸ”¬ Hands-on Lab: ${params.HANDS_ON_LAB ? 'Enabled' : 'Disabled'}"
                    echo "â•‘  ğŸ“¦ Namespace: ${params.NAMESPACE}"
                    echo "â•‘  ğŸ·ï¸  K8s Version: ${env.K8S_VERSION}"
                    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    
                    // Initialize learning progress
                    env.LEARNING_PROGRESS = '0'
                    env.ACHIEVEMENTS = 'ğŸš€ K8s Commander Started'
                }
            }
        }
        
        stage('ğŸ“š Kubernetes Concepts Overview') {
            steps {
                script {
                    echo "ğŸ“š Exploring Kubernetes Concepts through Jenkins..."
                    echo ""
                    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                    echo "â•‘                    ğŸ“š KUBERNETES CONCEPTS OVERVIEW                           â•‘"
                    echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
                    
                    // Dynamic concept explanation based on selection
                    def conceptExplanations = [
                        'Pods': [
                            'ğŸ¯ What are Pods?',
                            'â€¢ Smallest deployable unit in Kubernetes',
                            'â€¢ Contains one or more containers',
                            'â€¢ Shares network and storage resources',
                            'â€¢ Ephemeral - can be created and destroyed',
                            'â€¢ Example: Web server + sidecar container'
                        ],
                        'Services': [
                            'ğŸŒ What are Services?',
                            'â€¢ Stable network endpoint for Pods',
                            'â€¢ Provides load balancing and service discovery',
                            'â€¢ Types: ClusterIP, NodePort, LoadBalancer',
                            'â€¢ Enables communication between components',
                            'â€¢ Example: Frontend â†’ Backend communication'
                        ],
                        'Deployments': [
                            'ğŸš€ What are Deployments?',
                            'â€¢ Manages Pod replicas and updates',
                            'â€¢ Provides rolling updates and rollbacks',
                            'â€¢ Ensures desired state is maintained',
                            'â€¢ Handles scaling up and down',
                            'â€¢ Example: Web application with 3 replicas'
                        ],
                        'ConfigMaps': [
                            'âš™ï¸ What are ConfigMaps?',
                            'â€¢ Stores configuration data as key-value pairs',
                            'â€¢ Separates configuration from application code',
                            'â€¢ Can be mounted as files or environment variables',
                            'â€¢ Non-sensitive configuration data',
                            'â€¢ Example: Database connection strings'
                        ],
                        'Secrets': [
                            'ğŸ” What are Secrets?',
                            'â€¢ Stores sensitive data (passwords, tokens)',
                            'â€¢ Base64 encoded (not encrypted by default)',
                            'â€¢ Can be mounted as files or environment variables',
                            'â€¢ Better than hardcoding sensitive data',
                            'â€¢ Example: API keys, database passwords'
                        ],
                        'Ingress': [
                            'ğŸŒ What is Ingress?',
                            'â€¢ Manages external access to services',
                            'â€¢ Provides HTTP/HTTPS routing',
                            'â€¢ SSL termination and load balancing',
                            'â€¢ Path-based and host-based routing',
                            'â€¢ Example: myapp.com/api â†’ backend service'
                        ]
                    ]
                    
                    def selectedConcept = params.K8S_CONCEPT
                    if (selectedConcept == 'All Concepts') {
                        conceptExplanations.each { concept, explanation ->
                            echo "â•‘"
                            echo "â•‘  ${concept}:"
                            explanation.each { line ->
                                echo "â•‘     ${line}"
                            }
                        }
                    } else {
                        echo "â•‘  ${selectedConcept}:"
                        conceptExplanations[selectedConcept].each { line ->
                            echo "â•‘     ${line}"
                        }
                    }
                    
                    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    
                    // Update progress
                    env.LEARNING_PROGRESS = '20'
                    env.ACHIEVEMENTS += ', ğŸ“š Concepts Learned'
                }
            }
        }
        
        stage('ğŸ® Interactive K8s Demo') {
            when {
                expression { params.INTERACTIVE_DEMO == true }
            }
            steps {
                script {
                    echo "ğŸ® Launching Interactive Kubernetes Demo..."
                    echo ""
                    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                    echo "â•‘                    ğŸ® INTERACTIVE K8S DEMO                                  â•‘"
                    echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
                    
                    // Create interactive demo based on concept
                        sh '''
                        echo "â•‘  ğŸ¯ Interactive Demo: ${CURRENT_CONCEPT}"
                        echo "â•‘  ğŸ“Š Learning Level: ${LEARNING_LEVEL}"
                        echo "â•‘"
                        echo "â•‘  ğŸš€ Simulating Kubernetes operations..."
                        
                        # Simulate kubectl commands based on concept
                        case "${CURRENT_CONCEPT}" in
                            "Pods")
                                echo "â•‘     â€¢ kubectl get pods"
                                echo "â•‘     â€¢ kubectl describe pod my-pod"
                                echo "â•‘     â€¢ kubectl logs my-pod"
                                echo "â•‘     â€¢ kubectl exec -it my-pod -- /bin/bash"
                                ;;
                            "Services")
                                echo "â•‘     â€¢ kubectl get services"
                                echo "â•‘     â€¢ kubectl expose deployment my-app --port=80"
                                echo "â•‘     â€¢ kubectl get endpoints"
                                echo "â•‘     â€¢ kubectl port-forward service/my-service 8080:80"
                                ;;
                            "Deployments")
                                echo "â•‘     â€¢ kubectl get deployments"
                                echo "â•‘     â€¢ kubectl create deployment my-app --image=nginx"
                                echo "â•‘     â€¢ kubectl scale deployment my-app --replicas=3"
                                echo "â•‘     â€¢ kubectl rollout status deployment/my-app"
                                ;;
                            "ConfigMaps")
                                echo "â•‘     â€¢ kubectl get configmaps"
                                echo "â•‘     â€¢ kubectl create configmap my-config --from-literal=key=value"
                                echo "â•‘     â€¢ kubectl describe configmap my-config"
                                echo "â•‘     â€¢ kubectl get configmap my-config -o yaml"
                                ;;
                            "Secrets")
                                echo "â•‘     â€¢ kubectl get secrets"
                                echo "â•‘     â€¢ kubectl create secret generic my-secret --from-literal=password=secret"
                                echo "â•‘     â€¢ kubectl describe secret my-secret"
                                echo "â•‘     â€¢ kubectl get secret my-secret -o yaml"
                                ;;
                            "Ingress")
                                echo "â•‘     â€¢ kubectl get ingress"
                                echo "â•‘     â€¢ kubectl apply -f ingress.yaml"
                                echo "â•‘     â€¢ kubectl describe ingress my-ingress"
                                echo "â•‘     â€¢ kubectl get ingress my-ingress -o yaml"
                                ;;
                            "All Concepts")
                                echo "â•‘     â€¢ kubectl get all"
                                echo "â•‘     â€¢ kubectl get pods,services,deployments"
                                echo "â•‘     â€¢ kubectl get configmaps,secrets"
                                echo "â•‘     â€¢ kubectl get ingress"
                                ;;
                        esac
                        
                        echo "â•‘"
                        echo "â•‘  âœ… Interactive demo completed successfully!"
                        echo "â•‘  ğŸ’¡ These commands would work in a real Kubernetes cluster"
                    '''
                    
                    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    
                    // Update progress
                    env.LEARNING_PROGRESS = '40'
                    env.ACHIEVEMENTS += ', ğŸ® Demo Completed'
                }
            }
        }
        
        stage('ğŸ”¬ Hands-on Lab Exercise') {
            when {
                expression { params.HANDS_ON_LAB == true }
            }
            steps {
                script {
                    echo "ğŸ”¬ Starting Hands-on Lab Exercise..."
                    echo ""
                    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                    echo "â•‘                    ğŸ”¬ HANDS-ON LAB EXERCISE                                 â•‘"
                    echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
                    
                    // Create lab exercise files
                        sh '''
                        echo "â•‘  ğŸ¯ Lab Exercise: ${CURRENT_CONCEPT} Practice"
                        echo "â•‘  ğŸ“¦ Namespace: ${NAMESPACE}"
                        echo "â•‘"
                        echo "â•‘  ğŸ“ Creating lab exercise files..."
                        
                        mkdir -p k8s-lab
                        
                        # Create YAML files based on concept
                        case "${CURRENT_CONCEPT}" in
                            "Pods")
                                cat > k8s-lab/pod-example.yaml << 'EOF'
apiVersion: v1
kind: Pod
metadata:
  name: nginx-pod
  labels:
    app: nginx
spec:
  containers:
  - name: nginx
    image: nginx:latest
    ports:
    - containerPort: 80
EOF
                                echo "â•‘     â€¢ Created pod-example.yaml"
                                ;;
                            "Services")
                                cat > k8s-lab/service-example.yaml << 'EOF'
apiVersion: v1
kind: Service
metadata:
  name: nginx-service
spec:
  selector:
    app: nginx
  ports:
  - port: 80
    targetPort: 80
  type: ClusterIP
EOF
                                echo "â•‘     â€¢ Created service-example.yaml"
                                ;;
                            "Deployments")
                                cat > k8s-lab/deployment-example.yaml << 'EOF'
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:latest
        ports:
        - containerPort: 80
EOF
                                echo "â•‘     â€¢ Created deployment-example.yaml"
                                ;;
                            "ConfigMaps")
                                cat > k8s-lab/configmap-example.yaml << 'EOF'
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
data:
  database_url: "mysql://localhost:3306/mydb"
  debug_mode: "true"
  max_connections: "100"
EOF
                                echo "â•‘     â€¢ Created configmap-example.yaml"
                                ;;
                            "Secrets")
                                cat > k8s-lab/secret-example.yaml << 'EOF'
apiVersion: v1
kind: Secret
metadata:
  name: app-secret
type: Opaque
data:
  username: YWRtaW4=  # base64 encoded 'admin'
  password: cGFzc3dvcmQ=  # base64 encoded 'password'
EOF
                                echo "â•‘     â€¢ Created secret-example.yaml"
                                ;;
                            "Ingress")
                                cat > k8s-lab/ingress-example.yaml << 'EOF'
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: app-ingress
spec:
  rules:
  - host: myapp.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: nginx-service
            port:
              number: 80
EOF
                                echo "â•‘     â€¢ Created ingress-example.yaml"
                                ;;
                            "All Concepts")
                                # Create all example files
                                echo "â•‘     â€¢ Creating comprehensive lab with all concepts..."
                                echo "â•‘     â€¢ This would include Pods, Services, Deployments,"
                                echo "â•‘     â€¢ ConfigMaps, Secrets, and Ingress examples"
                                ;;
                        esac
                        
                        echo "â•‘"
                        echo "â•‘  ğŸ“‹ Lab Instructions:"
                        echo "â•‘     1. Review the generated YAML files"
                        echo "â•‘     2. Understand the structure and fields"
                        echo "â•‘     3. Try applying them to a K8s cluster:"
                        echo "â•‘        kubectl apply -f k8s-lab/"
                        echo "â•‘     4. Verify with: kubectl get all"
                        echo "â•‘"
                        echo "â•‘  âœ… Lab exercise files created successfully!"
                    '''
                    
                    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    
                    // Update progress
                    env.LEARNING_PROGRESS = '60'
                    env.ACHIEVEMENTS += ', ğŸ”¬ Lab Completed'
                }
            }
        }
        
        stage('ğŸŒ Interactive Learning Dashboard') {
            steps {
                script {
                    echo "ğŸŒ Generating Interactive Learning Dashboard..."
                    echo ""
                    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                    echo "â•‘                ğŸŒ INTERACTIVE LEARNING DASHBOARD                           â•‘"
                    echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
                    
                    // Find available port starting from 8081
                        sh '''
                        echo "â•‘  ğŸ¯ Creating interactive learning dashboard..."
                        mkdir -p dashboard
                        
                        # Use Flask default port 5000 (avoiding Jenkins on 8080)
                        DASHBOARD_PORT=5000
                        while netstat -tuln 2>/dev/null | grep -q ":$DASHBOARD_PORT " || docker ps --format "{{.Ports}}" 2>/dev/null | grep -q ":$DASHBOARD_PORT"; do
                            DASHBOARD_PORT=$((DASHBOARD_PORT + 1))
                            if [ $DASHBOARD_PORT -gt 5010 ]; then
                                echo "â•‘  âŒ No available ports found (5000-5010)"
                                exit 1
                            fi
                        done
                        
                        echo "â•‘  ğŸŒ Using port: $DASHBOARD_PORT"
                        
                        # Create dynamic Python web application
                        cat > dashboard/app.py << 'EOF'
#!/usr/bin/env python3
import os
import json
import time
from datetime import datetime
from flask import Flask, render_template_string, jsonify

app = Flask(__name__)

# Get Jenkins environment variables
K8S_CONCEPT = os.environ.get('CURRENT_CONCEPT', 'Pods')
LEARNING_LEVEL = os.environ.get('LEARNING_LEVEL', 'Beginner')
NAMESPACE = os.environ.get('NAMESPACE', 'k8s-learning')
K8S_VERSION = os.environ.get('K8S_VERSION', '1.28')
INTERACTIVE_DEMO = os.environ.get('INTERACTIVE_DEMO', 'true').lower() == 'true'
HANDS_ON_LAB = os.environ.get('HANDS_ON_LAB', 'true').lower() == 'true'

# Learning progress tracking
LEARNING_PROGRESS = 0
ACHIEVEMENTS = ['ğŸš€ K8s Commander Started']

def update_progress(progress, achievement):
    global LEARNING_PROGRESS, ACHIEVEMENTS
    LEARNING_PROGRESS = progress
    if achievement not in ACHIEVEMENTS:
        ACHIEVEMENTS.append(achievement)

# Simulate learning progression
update_progress(20, 'ğŸ“š Concepts Learned')
update_progress(40, 'ğŸ® Demo Completed')
update_progress(60, 'ğŸ”¬ Lab Completed')
update_progress(80, 'ğŸŒ Dashboard Created')
update_progress(100, 'ğŸ“ Mastery Achieved')

HTML_TEMPLATE = """<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K8s Commander - Learning Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .header h1 { font-size: 3em; margin-bottom: 10px; color: white; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3); }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.3s ease;
        }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease;
        }
        .card:hover { transform: translateY(-5px); }
        .achievement { display: inline-block; margin: 5px; padding: 5px 10px; background: #4CAF50; color: white; border-radius: 15px; font-size: 0.9em; }
        .concept-highlight { color: #2196F3; font-weight: bold; }
        .level-badge { display: inline-block; padding: 5px 15px; border-radius: 20px; font-weight: bold; }
        .beginner { background: #4CAF50; color: white; }
        .intermediate { background: #FF9800; color: white; }
        .advanced { background: #F44336; color: white; }
        .live-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: #4CAF50;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ K8s Commander</h1>
            <p>Your Kubernetes Learning Journey</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar" style="width: {{ progress }}%"></div>
            </div>
            <p>Progress: <span id="progressText">{{ progress }}</span>% Complete <span class="live-indicator"></span></p>
        </div>
        
        <div class="dashboard">
            <div class="card">
                <h3>ğŸ¯ Current Focus</h3>
                <p><strong>Concept:</strong> <span class="concept-highlight">{{ concept }}</span></p>
                <p><strong>Level:</strong> <span class="level-badge {{ level_class }}">{{ level }}</span></p>
                <p><strong>Namespace:</strong> {{ namespace }}</p>
                <p><strong>K8s Version:</strong> {{ k8s_version }}</p>
            </div>
            
            <div class="card">
                <h3>ğŸ† Achievements</h3>
                <div id="achievements">
                    {% for achievement in achievements %}
                    <span class="achievement">{{ achievement }}</span>
                    {% endfor %}
                </div>
            </div>
            
            <div class="card">
                <h3>ğŸ“š Learning Path</h3>
                <ul>
                    <li>âœ… Kubernetes Concepts Overview</li>
                    <li>âœ… Interactive Demo</li>
                    <li>âœ… Hands-on Lab</li>
                    <li>ğŸ”„ Learning Dashboard</li>
                    <li>â³ Next: Advanced K8s Patterns</li>
                </ul>
            </div>
            
            <div class="card">
                <h3>ğŸ® Interactive Features</h3>
                <p><strong>Demo Mode:</strong> {{ 'âœ… Enabled' if interactive_demo else 'âŒ Disabled' }}</p>
                <p><strong>Lab Mode:</strong> {{ 'âœ… Enabled' if hands_on_lab else 'âŒ Disabled' }}</p>
                <p><strong>Real-time Updates:</strong> âœ… Active</p>
            </div>
            
            <div class="card">
                <h3>ğŸ“Š Live Metrics</h3>
                <p><strong>Current Time:</strong> <span id="currentTime">{{ current_time }}</span></p>
                <p><strong>Learning Duration:</strong> <span id="duration">{{ duration }}</span></p>
                <p><strong>Pipeline Status:</strong> <span style="color: #4CAF50;">âœ… Running</span></p>
            </div>
        </div>
    </div>
    
    <script>
        // Real-time updates
        function updateProgress() {
            fetch('/api/progress')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('progressBar').style.width = data.progress + '%';
                    document.getElementById('progressText').textContent = data.progress;
                });
        }
        
        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString();
        }
        
        // Update every 2 seconds
        setInterval(updateProgress, 2000);
        setInterval(updateTime, 1000);
        
        // Initial update
        updateProgress();
        updateTime();
    </script>
</body>
</html>"""

@app.route('/')
def dashboard():
    level_class = LEARNING_LEVEL.lower()
    current_time = datetime.now().strftime('%H:%M:%S')
    duration = 'Active'
    
    return render_template_string(HTML_TEMPLATE,
        concept=K8S_CONCEPT,
        level=LEARNING_LEVEL,
        level_class=level_class,
        namespace=NAMESPACE,
        k8s_version=K8S_VERSION,
        progress=LEARNING_PROGRESS,
        achievements=ACHIEVEMENTS,
        interactive_demo=INTERACTIVE_DEMO,
        hands_on_lab=HANDS_ON_LAB,
        current_time=current_time,
        duration=duration
    )

@app.route('/api/progress')
def api_progress():
    return jsonify({
        'progress': LEARNING_PROGRESS,
        'achievements': ACHIEVEMENTS,
        'concept': K8S_CONCEPT,
        'level': LEARNING_LEVEL,
        'timestamp': time.time()
    })

if __name__ == '__main__':
    import sys
    port = int(sys.argv[1]) if len(sys.argv) > 1 else 5000
    app.run(host='0.0.0.0', port=port, debug=False)
EOF

                        # Create requirements.txt for Flask
                        cat > dashboard/requirements.txt << 'EOF'
Flask==2.3.3
Werkzeug==2.3.7
EOF

                        # Install Flask and start the application
                        echo "â•‘  ğŸ“¦ Installing Flask dependencies..."
                        pip3 install -r dashboard/requirements.txt
        
                        echo "â•‘  ğŸš€ Starting dynamic K8s Commander dashboard..."
                        echo "â•‘     â€¢ Interactive dashboard created"
                        echo "â•‘     â€¢ Real-time progress tracking enabled"
                        echo "â•‘     â€¢ Achievement system active"
                        echo "â•‘"
                        echo "â•‘  ğŸŒ Dashboard Features:"
                        echo "â•‘     â€¢ Live progress tracking"
                        echo "â•‘     â€¢ Achievement badges"
                        echo "â•‘     â€¢ Learning path visualization"
                        echo "â•‘     â€¢ Interactive concept exploration"
                        echo "â•‘     â€¢ Real-time updates"
                        
                        # Start Flask web server in background
                        echo "â•‘  ğŸš€ Starting Flask web server on port $DASHBOARD_PORT..."
                        cd dashboard
                        chmod +x app.py
                        
                        # Set environment variables for Flask app
                        export CURRENT_CONCEPT="${CURRENT_CONCEPT}"
                        export LEARNING_LEVEL="${LEARNING_LEVEL}"
                        export NAMESPACE="${NAMESPACE}"
                        export K8S_VERSION="${K8S_VERSION}"
                        export INTERACTIVE_DEMO="${INTERACTIVE_DEMO}"
                        export HANDS_ON_LAB="${HANDS_ON_LAB}"
                        
                        nohup python3 app.py $DASHBOARD_PORT > ../dashboard.log 2>&1 &
                        WEB_SERVER_PID=$!
                        echo $WEB_SERVER_PID > ../dashboard.pid
                        
                        # Test if Flask app can start
                        echo "â•‘  ğŸ§ª Testing Flask app startup..."
                        python3 -c "import app; print('Flask app imports successfully')" 2>&1 || echo "Flask app import failed"
                        
                        # Create a simple fallback Flask app if the main one fails
                        cat > simple_app.py << 'SIMPLE_EOF'
#!/usr/bin/env python3
from flask import Flask
import sys

app = Flask(__name__)

@app.route('/')
def hello():
    return """
    <html>
    <head><title>K8s Commander - Simple Dashboard</title></head>
    <body style="font-family: Arial; text-align: center; padding: 50px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <h1>ğŸš€ K8s Commander Dashboard</h1>
        <p>Jenkins Pipeline: Working!</p>
        <p>Port: """ + str(sys.argv[1] if len(sys.argv) > 1 else 5000) + """</p>
        <p>Status: âœ… Active</p>
    </body>
    </html>
    """

if __name__ == '__main__':
    port = int(sys.argv[1]) if len(sys.argv) > 1 else 5000
    app.run(host='0.0.0.0', port=port, debug=False)
SIMPLE_EOF
                        
                        # Verify the server started
                        sleep 3
                        if ps -p $WEB_SERVER_PID > /dev/null 2>&1; then
                            echo "â•‘  âœ… Flask server started successfully (PID: $WEB_SERVER_PID)"
                            # Test if server responds
                            sleep 2
                            if curl -s http://localhost:$DASHBOARD_PORT/ > /dev/null 2>&1; then
                                echo "â•‘  âœ… Flask server is responding to requests"
                            else
                                echo "â•‘  âš ï¸  Flask server started but not responding to requests"
                            fi
                        else
                            echo "â•‘  âŒ Main Flask server failed to start. Trying fallback..."
                            cat ../dashboard.log
                            
                            # Kill any existing process and try simple app
                            kill $WEB_SERVER_PID 2>/dev/null || true
                            sleep 1
                            
                            echo "â•‘  ğŸ”„ Starting simple fallback Flask app..."
                            chmod +x simple_app.py
                            nohup python3 simple_app.py $DASHBOARD_PORT > ../dashboard.log 2>&1 &
                            WEB_SERVER_PID=$!
                            echo $WEB_SERVER_PID > ../dashboard.pid
                            
                            sleep 3
                            if ps -p $WEB_SERVER_PID > /dev/null 2>&1; then
                                echo "â•‘  âœ… Fallback Flask server started successfully (PID: $WEB_SERVER_PID)"
                            else
                                echo "â•‘  âŒ Both Flask servers failed to start"
                                cat ../dashboard.log
                            fi
                        fi
                        
                        # Wait a moment for server to start
                        sleep 2
                        
                        # Get host IP
                        HOST_IP=$(hostname -I | awk '{print $1}')
                        
                        echo "â•‘  âœ… Dashboard started successfully!"
                        echo "â•‘  ğŸŒ Access URLs:"
                        echo "â•‘     â€¢ Local: http://localhost:$DASHBOARD_PORT/"
                        echo "â•‘     â€¢ Network: http://$HOST_IP:$DASHBOARD_PORT/"
                        echo "â•‘  ğŸ†” Process ID: $WEB_SERVER_PID"
                    '''
                    
                    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    
                    // Update progress
                    env.LEARNING_PROGRESS = '80'
                    env.ACHIEVEMENTS += ', ğŸŒ Dashboard Created'
                }
            }
        }
        
        stage('ğŸ“ K8s Mastery Assessment') {
            steps {
                script {
                    echo "ğŸ“ Conducting K8s Mastery Assessment..."
                    echo ""
                    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                    echo "â•‘                    ğŸ“ K8S MASTERY ASSESSMENT                               â•‘"
                    echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
                    
                    sh '''
                        echo "â•‘  ğŸ“Š Assessment Results:"
                        echo "â•‘     â€¢ Concept Understanding: âœ… Excellent"
                        echo "â•‘     â€¢ Hands-on Practice: âœ… Completed"
                        echo "â•‘     â€¢ Interactive Learning: âœ… Engaged"
                        echo "â•‘     â€¢ Progress Tracking: âœ… ${LEARNING_PROGRESS}%"
                        echo "â•‘"
                        echo "â•‘  ğŸ† Mastery Level Achieved:"
                        case "${LEARNING_LEVEL}" in
                            "Beginner")
                                echo "â•‘     â€¢ ğŸ¥‰ Bronze Level - K8s Explorer"
                                echo "â•‘     â€¢ Ready for: Basic K8s operations"
                                echo "â•‘     â€¢ Next: Intermediate concepts"
                                ;;
                            "Intermediate")
                                echo "â•‘     â€¢ ğŸ¥ˆ Silver Level - K8s Practitioner"
                                echo "â•‘     â€¢ Ready for: Production deployments"
                                echo "â•‘     â€¢ Next: Advanced patterns"
                                ;;
                            "Advanced")
                                echo "â•‘     â€¢ ğŸ¥‡ Gold Level - K8s Master"
                                echo "â•‘     â€¢ Ready for: Complex architectures"
                                echo "â•‘     â€¢ Next: K8s administration"
                                ;;
                        esac
                        echo "â•‘"
                        echo "â•‘  ğŸ¯ Key Learnings:"
                        echo "â•‘     â€¢ Kubernetes concepts through Jenkins"
                        echo "â•‘     â€¢ YAML configuration understanding"
                        echo "â•‘     â€¢ kubectl command familiarity"
                        echo "â•‘     â€¢ Real-world application patterns"
                        echo "â•‘"
                        echo "â•‘  ğŸš€ Next Steps:"
                        echo "â•‘     â€¢ Practice with real K8s cluster"
                        echo "â•‘     â€¢ Explore advanced K8s features"
                        echo "â•‘     â€¢ Learn K8s administration"
                        echo "â•‘     â€¢ Master CI/CD with K8s"
                    '''
                    
                    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    
                    // Final progress update
                    env.LEARNING_PROGRESS = '100'
                    env.ACHIEVEMENTS += ', ğŸ“ Mastery Achieved'
                }
            }
        }
    }
    
    post {
        always {
            script {
                // Cleanup web server
                sh '''
                    if [ -f dashboard.pid ]; then
                        DASHBOARD_PORT=$(cat dashboard.pid)
                        WEB_SERVER_PID=$(ps aux | grep "python3 app.py $DASHBOARD_PORT" | grep -v grep | awk '{print $2}')
                        if [ ! -z "$WEB_SERVER_PID" ]; then
                            echo "ğŸ›‘ Stopping K8s Commander dashboard (PID: $WEB_SERVER_PID)..."
                            kill $WEB_SERVER_PID
                            sleep 1
                            if kill -0 $WEB_SERVER_PID 2>/dev/null; then
                                kill -9 $WEB_SERVER_PID
                            fi
                            echo "âœ… K8s Commander dashboard stopped"
                        fi
                        rm -f dashboard.pid
                    fi
                '''
                
                echo ""
                echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                echo "â•‘                    ğŸ‰ K8S COMMANDER COMPLETED!                               â•‘"
                echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
                echo "â•‘  ğŸ¯ Learning Journey Summary:"
                echo "â•‘     â€¢ Concept Explored: ${params.K8S_CONCEPT}"
                echo "â•‘     â€¢ Learning Level: ${params.LEARNING_LEVEL}"
                echo "â•‘     â€¢ Progress Achieved: ${env.LEARNING_PROGRESS}%"
                echo "â•‘     â€¢ Achievements: ${env.ACHIEVEMENTS}"
                echo "â•‘"
                sh '''
                    if [ -f dashboard.pid ]; then
                        DASHBOARD_PORT=$(cat dashboard.pid)
                        HOST_IP=$(hostname -I | awk '{print $1}')
                        echo "â•‘  ğŸŒ Dashboard was available at:"
                        echo "â•‘     â€¢ Local: http://localhost:$DASHBOARD_PORT/"
                        echo "â•‘     â€¢ Network: http://$HOST_IP:$DASHBOARD_PORT/"
                    else
                        echo "â•‘  ğŸŒ Dashboard was available during pipeline execution"
                    fi
                '''
                echo "â•‘  ğŸ“ Generated files: dashboard/ directory with Flask app"
                echo "â•‘  ğŸ“‹ Lab files: k8s-lab/ directory with YAML examples"
                echo "â•‘"
                echo "â•‘  ğŸš€ Ready for Next Level:"
                echo "â•‘     â€¢ Scenario 5: Jenkins CI/CD Mastery"
                echo "â•‘     â€¢ Advanced Jenkins features"
                echo "â•‘     â€¢ Production-ready CI/CD patterns"
                echo "â•‘     â€¢ Then: Full Kubernetes deployment"
                echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            }
        }
        success {
            script {
                echo "ğŸ‰ K8s Commander learning journey completed successfully!"
                echo "ğŸ† You've mastered Kubernetes concepts through Jenkins!"
            }
        }
        failure {
            script {
                echo "âŒ K8s Commander encountered issues, but learning continues!"
                echo "ğŸ”„ Retry the pipeline to continue your journey."
            }
        }
    }
}