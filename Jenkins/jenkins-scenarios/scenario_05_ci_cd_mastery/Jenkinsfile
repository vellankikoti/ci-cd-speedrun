pipeline {
    agent any

    options {
        timeout(time: 15, unit: 'MINUTES')
        timestamps()
        buildDiscarder(logRotator(numToKeepStr: '30', artifactNumToKeepStr: '10'))
    }

    parameters {
        choice(
            name: 'DEPLOYMENT_STRATEGY',
            choices: ['Blue-Green', 'Canary', 'Rolling', 'Recreate'],
            description: 'ğŸ¯ Deployment Strategy to Learn'
        )
        choice(
            name: 'APP_COMPLEXITY',
            choices: ['Simple', 'Advanced', 'Production'],
            description: 'ğŸ“Š Application Complexity Level'
        )
        string(
            name: 'INITIAL_VERSION',
            defaultValue: '1.0.0',
            description: 'ğŸ“¦ Starting Application Version'
        )
        booleanParam(
            name: 'REQUIRE_APPROVAL',
            defaultValue: false,
            description: 'âœ‹ Require manual approval before deployment (recommended for Production)'
        )
        string(
            name: 'APPROVER_EMAIL',
            defaultValue: 'devops@company.com',
            description: 'ğŸ“§ Email address for deployment notifications'
        )
    }

    environment {
        WORKSPACE_DIR = "${WORKSPACE}"
        BUILD_NUM = "${BUILD_NUMBER}"
    }

    stages {
        stage('ğŸ¯ Initialize') {
            steps {
                script {
                    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                    echo "â•‘    ğŸ¯ CI/CD MASTERY - LIVE DEPLOYMENT SIMULATOR                      â•‘"
                    echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
                    echo "â•‘  Strategy: ${params.DEPLOYMENT_STRATEGY}"
                    echo "â•‘  Complexity: ${params.APP_COMPLEXITY}"
                    echo "â•‘  Version: ${params.INITIAL_VERSION}"
                    echo "â•‘  Build: #${BUILD_NUMBER}"
                    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                }
                checkout scm
            }
        }

        stage('ğŸ—ï¸ Build Application') {
            steps {
                script {
                    echo "â•‘"
                    echo "â•‘  ğŸ“¦ Preparing live CI/CD simulator..."
                    echo "â•‘"

                    // Copy app.py from the repo
                    sh '''#!/bin/bash
                        cd Jenkins/jenkins-scenarios/scenario_05_ci_cd_mastery

                        if [ ! -f app.py ]; then
                            echo "âŒ Error: app.py not found!"
                            exit 1
                        fi

                        # Copy to workspace root for Docker build
                        cp app.py ${WORKSPACE}/
                        chmod +x ${WORKSPACE}/app.py

                        echo "â•‘     âœ… Application ready"
                    '''

                    // Create Dockerfile
                    writeFile file: 'Dockerfile', text: '''FROM python:3.11-slim

WORKDIR /app

RUN pip install --no-cache-dir flask flask-cors

COPY app.py .

EXPOSE 8080

HEALTHCHECK --interval=10s --timeout=3s --start-period=5s --retries=3 \\
    CMD python3 -c "import urllib.request; urllib.request.urlopen('http://localhost:8080/api/health')" || exit 1

CMD ["python3", "app.py"]
'''

                    echo "â•‘     âœ… Dockerfile created"

                    // Create deployment metadata
                    sh '''#!/bin/bash
                        mkdir -p deployment-artifacts
                        cat > deployment-artifacts/metadata.json << EOF
{
  "build_number": "${BUILD_NUMBER}",
  "deployment_strategy": "${DEPLOYMENT_STRATEGY}",
  "app_complexity": "${APP_COMPLEXITY}",
  "version": "${INITIAL_VERSION}",
  "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
  "git_commit": "${GIT_COMMIT:-unknown}",
  "git_branch": "${GIT_BRANCH:-unknown}",
  "jenkins_url": "${BUILD_URL}",
  "triggered_by": "${BUILD_USER:-system}"
}
EOF
                        echo "â•‘     âœ… Deployment metadata created"
                    '''
                }
            }
        }

        stage('âœ‹ Approval Gate') {
            when {
                expression { params.REQUIRE_APPROVAL == true }
            }
            steps {
                script {
                    echo ""
                    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                    echo "â•‘             âœ‹ MANUAL APPROVAL REQUIRED                               â•‘"
                    echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
                    echo "â•‘  Strategy: ${params.DEPLOYMENT_STRATEGY}"
                    echo "â•‘  Complexity: ${params.APP_COMPLEXITY}"
                    echo "â•‘  Version: ${params.INITIAL_VERSION}"
                    echo "â•‘  Build: #${BUILD_NUMBER}"
                    echo "â•‘"
                    echo "â•‘  â¸ï¸  Waiting for approval..."
                    echo "â•‘  ğŸ“§ Notification sent to: ${params.APPROVER_EMAIL}"
                    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

                    def deploymentInfo = """
Deployment Details:
â€¢ Strategy: ${params.DEPLOYMENT_STRATEGY}
â€¢ Complexity: ${params.APP_COMPLEXITY}
â€¢ Version: ${params.INITIAL_VERSION}
â€¢ Build: #${BUILD_NUMBER}
â€¢ Time: ${new Date().format('yyyy-MM-dd HH:mm:ss')}

Please review and approve to continue.
                    """

                    try {
                        timeout(time: 15, unit: 'MINUTES') {
                            input(
                                message: 'Approve deployment to Production?',
                                ok: 'Deploy',
                                submitter: 'admin,devops',
                                parameters: [
                                    choice(
                                        name: 'APPROVAL_ACTION',
                                        choices: ['Approve and Deploy', 'Reject'],
                                        description: 'Approve or reject this deployment'
                                    ),
                                    text(
                                        name: 'APPROVAL_NOTES',
                                        defaultValue: '',
                                        description: 'Optional: Add approval notes or comments'
                                    )
                                ]
                            )
                        }

                        sh '''#!/bin/bash
                            cat > deployment-artifacts/approval.txt << EOF
DEPLOYMENT APPROVED
===================
Approved at: $(date -u +%Y-%m-%dT%H:%M:%SZ)
Build: ${BUILD_NUMBER}
Strategy: ${DEPLOYMENT_STRATEGY}
Version: ${INITIAL_VERSION}
EOF
                        '''

                        echo ""
                        echo "âœ… Deployment approved! Proceeding..."
                    } catch (err) {
                        sh '''#!/bin/bash
                            cat > deployment-artifacts/approval.txt << EOF
DEPLOYMENT REJECTED
===================
Rejected at: $(date -u +%Y-%m-%dT%H:%M:%SZ)
Build: ${BUILD_NUMBER}
Reason: ${err.message}
EOF
                        '''
                        error("Deployment rejected or timed out: ${err.message}")
                    }
                }
            }
        }

        stage('ğŸ³ Build & Deploy') {
            steps {
                script {
                    echo "â•‘"
                    echo "â•‘  ğŸ³ Building and deploying live simulator..."
                    echo "â•‘"

                    sh '''#!/bin/bash
                        set -e

                        # Cleanup
                        echo "â•‘  ğŸ§¹ Cleaning up old containers..."
                        docker ps -a --filter "name=cicd-live" --format "{{.Names}}" | xargs -r docker rm -f || true
                        sleep 2

                        # Build
                        IMAGE_NAME="cicd-live-${BUILD_NUMBER}"
                        echo "â•‘  ğŸ”¨ Building image: $IMAGE_NAME"
                        docker build -t $IMAGE_NAME .
                        echo "â•‘     âœ… Image built"

                        # Find port and deploy
                        echo "â•‘  ğŸ” Finding available port..."
                        EXTERNAL_PORT=8081
                        MAX_ATTEMPTS=50
                        ATTEMPT=0
                        DEPLOY_SUCCESS=false

                        while [ $ATTEMPT -lt $MAX_ATTEMPTS ] && [ "$DEPLOY_SUCCESS" = "false" ]; do
                            PORT_IN_USE=false

                            if netstat -tuln 2>/dev/null | grep -q ":$EXTERNAL_PORT " || \\
                               lsof -i :$EXTERNAL_PORT 2>/dev/null | grep -q LISTEN || \\
                               docker ps --format "{{.Ports}}" 2>/dev/null | grep -q ":$EXTERNAL_PORT->"; then
                                PORT_IN_USE=true
                            fi

                            if [ "$PORT_IN_USE" = "true" ]; then
                                EXTERNAL_PORT=$((EXTERNAL_PORT + 1))
                                ATTEMPT=$((ATTEMPT + 1))
                                continue
                            fi

                            # Deploy
                            CONTAINER_NAME="cicd-live-${BUILD_NUMBER}"
                            docker rm -f $CONTAINER_NAME 2>/dev/null || true

                            if docker run -d \\
                                --name $CONTAINER_NAME \\
                                -p $EXTERNAL_PORT:8080 \\
                                -e DEPLOYMENT_STRATEGY="${DEPLOYMENT_STRATEGY}" \\
                                -e APP_COMPLEXITY="${APP_COMPLEXITY}" \\
                                -e INITIAL_VERSION="${INITIAL_VERSION}" \\
                                -e BUILD_NUMBER="${BUILD_NUMBER}" \\
                                $IMAGE_NAME 2>&1; then

                                echo "â•‘     âœ… Deployed on port $EXTERNAL_PORT"
                                DEPLOY_SUCCESS=true
                                echo $EXTERNAL_PORT > webapp.port
                                break
                            else
                                echo "â•‘     âš ï¸  Port $EXTERNAL_PORT failed, trying next port..."
                                docker rm -f $CONTAINER_NAME 2>/dev/null || true
                                EXTERNAL_PORT=$((EXTERNAL_PORT + 1))
                                ATTEMPT=$((ATTEMPT + 1))
                            fi
                        done

                        if [ "$DEPLOY_SUCCESS" = "false" ]; then
                            echo "â•‘     âŒ Deployment failed after $MAX_ATTEMPTS attempts"
                            exit 1
                        fi

                        # Health check
                        echo "â•‘  â³ Waiting for application to be ready..."
                        sleep 5
                        MAX_CHECKS=30
                        CHECK=0
                        while [ $CHECK -lt $MAX_CHECKS ]; do
                            if curl -f http://localhost:$EXTERNAL_PORT/api/health > /dev/null 2>&1; then
                                echo "â•‘     âœ… Application healthy and ready!"
                                break
                            fi
                            sleep 1
                            CHECK=$((CHECK + 1))
                        done

                        echo "â•‘"
                        echo "â•‘  ğŸ‰ Live simulator deployed successfully!"
                        echo "â•‘"
                        echo "â•‘  ğŸŒ Access your LIVE CI/CD simulator at:"
                        echo "â•‘     ğŸ‘‰ http://localhost:$EXTERNAL_PORT"
                        echo "â•‘"
                        echo "â•‘  ğŸ® Try these actions:"
                        echo "â•‘     â€¢ Click 'Deploy' to trigger ${DEPLOYMENT_STRATEGY} deployment"
                        echo "â•‘     â€¢ Watch live traffic switching in real-time"
                        echo "â•‘     â€¢ Click 'Rollback' to see instant rollback"
                        echo "â•‘     â€¢ Click 'Simulate Failure' to test failure scenarios"
                        echo "â•‘     â€¢ Watch metrics update live (requests, health, traffic)"
                        echo "â•‘"

                        # Save deployment report
                        cat > deployment-artifacts/deployment-report.txt << EOF
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                   DEPLOYMENT REPORT                                   â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Build: #${BUILD_NUMBER}
â•‘  Strategy: ${DEPLOYMENT_STRATEGY}
â•‘  Complexity: ${APP_COMPLEXITY}
â•‘  Version: ${INITIAL_VERSION}
â•‘  Port: $EXTERNAL_PORT
â•‘  Container: $CONTAINER_NAME
â•‘  Image: $IMAGE_NAME
â•‘  Status: SUCCESS âœ…
â•‘  Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)
â•‘
â•‘  ğŸŒ Access URL: http://localhost:$EXTERNAL_PORT
â•‘  ğŸ“Š Health Check: http://localhost:$EXTERNAL_PORT/api/health
â•‘  ğŸ“ˆ Metrics: http://localhost:$EXTERNAL_PORT/api/state
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF

                        # Create deployment summary HTML
                        cat > deployment-artifacts/deployment-summary.html << 'HTMLEOF'
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Deployment Report - Build #${BUILD_NUMBER}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; }
        .success { color: #27ae60; font-weight: bold; }
        .info { background: #ecf0f1; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .metric { display: inline-block; margin: 10px 20px 10px 0; }
        .metric-label { font-weight: bold; color: #7f8c8d; }
        .metric-value { color: #2c3e50; font-size: 1.1em; }
        a { color: #3498db; text-decoration: none; }
        a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ Deployment Report</h1>
        <p class="success">âœ… Deployment Successful</p>

        <div class="info">
            <h3>Build Information</h3>
            <div class="metric"><span class="metric-label">Build:</span> <span class="metric-value">#${BUILD_NUMBER}</span></div>
            <div class="metric"><span class="metric-label">Strategy:</span> <span class="metric-value">${DEPLOYMENT_STRATEGY}</span></div>
            <div class="metric"><span class="metric-label">Complexity:</span> <span class="metric-value">${APP_COMPLEXITY}</span></div>
            <div class="metric"><span class="metric-label">Version:</span> <span class="metric-value">${INITIAL_VERSION}</span></div>
            <div class="metric"><span class="metric-label">Timestamp:</span> <span class="metric-value">$(date)</span></div>
        </div>

        <div class="info">
            <h3>Deployment Details</h3>
            <div class="metric"><span class="metric-label">Container:</span> <span class="metric-value">$CONTAINER_NAME</span></div>
            <div class="metric"><span class="metric-label">Image:</span> <span class="metric-value">$IMAGE_NAME</span></div>
            <div class="metric"><span class="metric-label">Port:</span> <span class="metric-value">$EXTERNAL_PORT</span></div>
        </div>

        <div class="info">
            <h3>Access URLs</h3>
            <p>ğŸŒ <strong>Application:</strong> <a href="http://localhost:$EXTERNAL_PORT">http://localhost:$EXTERNAL_PORT</a></p>
            <p>ğŸ“Š <strong>Health:</strong> <a href="http://localhost:$EXTERNAL_PORT/api/health">http://localhost:$EXTERNAL_PORT/api/health</a></p>
            <p>ğŸ“ˆ <strong>Metrics:</strong> <a href="http://localhost:$EXTERNAL_PORT/api/state">http://localhost:$EXTERNAL_PORT/api/state</a></p>
        </div>

        <div class="info">
            <h3>ğŸ® Quick Actions</h3>
            <ul>
                <li>Click 'Deploy' to trigger ${DEPLOYMENT_STRATEGY} deployment</li>
                <li>Watch live traffic switching in real-time</li>
                <li>Click 'Rollback' to see instant rollback</li>
                <li>Click 'Simulate Failure' to test failure scenarios</li>
                <li>Monitor live metrics and health status</li>
            </ul>
        </div>
    </div>
</body>
</html>
HTMLEOF

                        echo "â•‘     âœ… Deployment artifacts created"
                    '''
                }
            }
        }

        stage('ğŸ“¦ Archive Artifacts') {
            steps {
                script {
                    echo ""
                    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                    echo "â•‘             ğŸ“¦ ARCHIVING DEPLOYMENT ARTIFACTS                         â•‘"
                    echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"

                    // Archive deployment artifacts
                    archiveArtifacts artifacts: 'deployment-artifacts/**/*',
                                   allowEmptyArchive: false,
                                   fingerprint: true,
                                   onlyIfSuccessful: true

                    // Archive Dockerfile
                    archiveArtifacts artifacts: 'Dockerfile',
                                   allowEmptyArchive: false,
                                   fingerprint: true

                    // Archive app.py
                    archiveArtifacts artifacts: 'app.py',
                                   allowEmptyArchive: false,
                                   fingerprint: true

                    echo "â•‘  âœ… Artifacts archived successfully"
                    echo "â•‘     â€¢ Deployment metadata (metadata.json)"
                    echo "â•‘     â€¢ Deployment report (deployment-report.txt)"
                    echo "â•‘     â€¢ HTML summary (deployment-summary.html)"
                    if (params.REQUIRE_APPROVAL) {
                        echo "â•‘     â€¢ Approval record (approval.txt)"
                    }
                    echo "â•‘     â€¢ Application files (app.py, Dockerfile)"
                    echo "â•‘"
                    echo "â•‘  ğŸ“Š View artifacts in Jenkins UI under 'Build Artifacts'"
                    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                }
            }
        }
    }

    post {
        always {
            script {
                echo ""
                echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                echo "â•‘                   ğŸ“ BUILD COMPLETE                                   â•‘"
                echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
                echo "â•‘  Strategy: ${params.DEPLOYMENT_STRATEGY}"
                echo "â•‘  Build: #${BUILD_NUMBER}"
                echo "â•‘"
                echo "â•‘  ğŸš€ What you can do:"
                echo "â•‘     âœ“ Trigger live deployments with different versions"
                echo "â•‘     âœ“ Watch real-time traffic switching"
                echo "â•‘     âœ“ Experience instant rollbacks"
                echo "â•‘     âœ“ Simulate failures and recoveries"
                echo "â•‘     âœ“ Monitor live metrics and health status"
                echo "â•‘     âœ“ See deployment logs in real-time"
                echo "â•‘"
                echo "â•‘  ğŸ’¡ This is a LIVE simulator - everything you see updates in real-time!"
                echo "â•‘  ğŸ¯ Perfect for understanding production CI/CD patterns interactively!"
                echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

                // Generate email notification body
                def buildStatus = currentBuild.result ?: 'SUCCESS'
                def deploymentUrl = "http://localhost:${sh(script: 'cat webapp.port 2>/dev/null || echo "8081"', returnStdout: true).trim()}"

                sh """#!/bin/bash
                    cat > deployment-artifacts/email-notification.html << 'EMAILEOF'
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; }
        .content { padding: 20px; background: #f9f9f9; }
        .section { background: white; margin: 15px 0; padding: 15px; border-left: 4px solid #667eea; }
        .success { color: #27ae60; font-weight: bold; }
        .pending { color: #f39c12; font-weight: bold; }
        .failed { color: #e74c3c; font-weight: bold; }
        .metric { display: inline-block; margin: 5px 15px 5px 0; }
        .label { font-weight: bold; color: #666; }
        .value { color: #333; }
        a { color: #667eea; text-decoration: none; }
        a:hover { text-decoration: underline; }
        .footer { text-align: center; padding: 15px; color: #999; font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸš€ CI/CD Deployment Notification</h1>
        <p>Build #${BUILD_NUMBER} - ${DEPLOYMENT_STRATEGY} Strategy</p>
    </div>

    <div class="content">
        <div class="section">
            <h2>ğŸ“Š Deployment Status: <span class="success">SUCCESS âœ…</span></h2>
            <p>Your deployment has completed successfully!</p>
        </div>

        <div class="section">
            <h3>ğŸ¯ Build Information</h3>
            <div class="metric"><span class="label">Build Number:</span> <span class="value">#${BUILD_NUMBER}</span></div><br>
            <div class="metric"><span class="label">Strategy:</span> <span class="value">${DEPLOYMENT_STRATEGY}</span></div><br>
            <div class="metric"><span class="label">Complexity:</span> <span class="value">${APP_COMPLEXITY}</span></div><br>
            <div class="metric"><span class="label">Version:</span> <span class="value">${INITIAL_VERSION}</span></div><br>
            <div class="metric"><span class="label">Timestamp:</span> <span class="value">\$(date)</span></div>
        </div>

        <div class="section">
            <h3>ğŸŒ Access Information</h3>
            <p>ğŸ”— <strong>Application URL:</strong> <a href="${deploymentUrl}">${deploymentUrl}</a></p>
            <p>ğŸ“Š <strong>Health Check:</strong> <a href="${deploymentUrl}/api/health">${deploymentUrl}/api/health</a></p>
            <p>ğŸ“ˆ <strong>Metrics API:</strong> <a href="${deploymentUrl}/api/state">${deploymentUrl}/api/state</a></p>
            <p>ğŸ”§ <strong>Jenkins Build:</strong> <a href="${BUILD_URL}">${BUILD_URL}</a></p>
        </div>

        <div class="section">
            <h3>ğŸ® Available Actions</h3>
            <ul>
                <li>Click 'Deploy' to trigger ${DEPLOYMENT_STRATEGY} deployment</li>
                <li>Watch live traffic switching in real-time</li>
                <li>Click 'Rollback' to see instant rollback mechanism</li>
                <li>Click 'Simulate Failure' to test failure scenarios</li>
                <li>Monitor live metrics and health status updates</li>
            </ul>
        </div>

        <div class="section">
            <h3>ğŸ“¦ Artifacts Available</h3>
            <p>Download deployment artifacts from: <a href="${BUILD_URL}artifact/">${BUILD_URL}artifact/</a></p>
            <ul>
                <li>Deployment metadata (JSON)</li>
                <li>Deployment report (TXT)</li>
                <li>HTML summary</li>
                <li>Application files (Dockerfile, app.py)</li>
            </ul>
        </div>
    </div>

    <div class="footer">
        <p>This is an automated notification from Jenkins CI/CD Mastery pipeline.</p>
        <p>For questions or issues, contact the DevOps team.</p>
    </div>
</body>
</html>
EMAILEOF
                """

                echo ""
                echo "â•‘  ğŸ“§ Email notification prepared"
                echo "â•‘     Recipient: ${params.APPROVER_EMAIL}"
                echo "â•‘     Status: ${buildStatus}"
            }
        }
        success {
            script {
                echo ""
                echo "ğŸ“§ Sending SUCCESS notification to ${params.APPROVER_EMAIL}"

                // Email notification for successful deployment
                emailext(
                    subject: "âœ… SUCCESS: Deployment #${BUILD_NUMBER} - ${params.DEPLOYMENT_STRATEGY} Strategy",
                    body: '''
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                 ğŸ‰ DEPLOYMENT SUCCESSFUL                              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£

Build Information:
â€¢ Build Number: #${BUILD_NUMBER}
â€¢ Strategy: ${DEPLOYMENT_STRATEGY}
â€¢ Complexity: ${APP_COMPLEXITY}
â€¢ Version: ${INITIAL_VERSION}
â€¢ Duration: ${BUILD_DURATION}
â€¢ Status: SUCCESS âœ…

Deployment Details:
â€¢ Timestamp: ${BUILD_TIMESTAMP}
â€¢ Jenkins URL: ${BUILD_URL}
â€¢ Artifacts: ${BUILD_URL}artifact/

Access Your Application:
ğŸŒ Check the build artifacts for the deployment URL
ğŸ“Š Health Check: Available at /api/health endpoint
ğŸ“ˆ Metrics: Available at /api/state endpoint

Quick Actions:
â€¢ Click 'Deploy' to trigger live deployment
â€¢ Watch real-time traffic switching
â€¢ Test instant rollback capability
â€¢ Simulate failure scenarios
â€¢ Monitor live metrics

View detailed deployment report in Jenkins artifacts.

â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    ''',
                    to: "${params.APPROVER_EMAIL}",
                    from: 'jenkins@cicd-mastery.local',
                    replyTo: 'devops@cicd-mastery.local',
                    mimeType: 'text/plain',
                    attachLog: false,
                    compressLog: false,
                    attachmentsPattern: 'deployment-artifacts/deployment-report.txt,deployment-artifacts/deployment-summary.html'
                )

                echo "âœ… SUCCESS notification sent to ${params.APPROVER_EMAIL}"
            }
        }
        failure {
            script {
                echo ""
                echo "ğŸ“§ Sending FAILURE notification to ${params.APPROVER_EMAIL}"

                // Email notification for failed deployment
                emailext(
                    subject: "âŒ FAILED: Deployment #${BUILD_NUMBER} - ${params.DEPLOYMENT_STRATEGY} Strategy",
                    body: '''
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                 âŒ DEPLOYMENT FAILED                                  â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£

Build Information:
â€¢ Build Number: #${BUILD_NUMBER}
â€¢ Strategy: ${DEPLOYMENT_STRATEGY}
â€¢ Complexity: ${APP_COMPLEXITY}
â€¢ Version: ${INITIAL_VERSION}
â€¢ Duration: ${BUILD_DURATION}
â€¢ Status: FAILED âŒ

Failure Details:
â€¢ Check Jenkins console output for detailed error logs
â€¢ Jenkins URL: ${BUILD_URL}console
â€¢ Build artifacts (if any): ${BUILD_URL}artifact/

Recommended Actions:
1. Review the console output for error details
2. Check Docker container logs if deployment reached that stage
3. Verify all prerequisites and dependencies
4. Review recent code changes that may have caused the failure
5. Contact the DevOps team if issue persists

Troubleshooting:
â€¢ Verify Docker is running and accessible
â€¢ Check port availability (8081-8131 range)
â€¢ Ensure sufficient system resources
â€¢ Review security and firewall settings
â€¢ Validate application dependencies

â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    ''',
                    to: "${params.APPROVER_EMAIL}",
                    from: 'jenkins@cicd-mastery.local',
                    replyTo: 'devops@cicd-mastery.local',
                    mimeType: 'text/plain',
                    attachLog: true,
                    compressLog: true
                )

                echo "âœ… FAILURE notification sent to ${params.APPROVER_EMAIL}"
            }
        }
        unstable {
            script {
                echo ""
                echo "ğŸ“§ Sending UNSTABLE notification to ${params.APPROVER_EMAIL}"

                emailext(
                    subject: "âš ï¸ UNSTABLE: Deployment #${BUILD_NUMBER} - ${params.DEPLOYMENT_STRATEGY}",
                    body: "Build #${BUILD_NUMBER} is unstable. Please review: ${BUILD_URL}",
                    to: "${params.APPROVER_EMAIL}",
                    from: 'jenkins@cicd-mastery.local',
                    mimeType: 'text/plain',
                    attachLog: true
                )

                echo "âœ… UNSTABLE notification sent"
            }
        }
    }
}
