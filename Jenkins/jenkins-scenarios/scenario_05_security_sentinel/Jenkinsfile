pipeline {
    agent any
    
    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timestamps()
        timeout(time: 4, unit: 'MINUTES')
    }
    
    environment {
        APP_NAME = 'security-sentinel'
        DOCKER_IMAGE = "jenkins-workshop/${APP_NAME}"
    }

    stages {
        stage('ğŸ¬ THE DEVSECOPS REVOLUTION') {
            steps {
                script {
                    echo 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”'
                    echo '        BEFORE: Security as Afterthought (The Old Way)'
                    echo 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”'
                    echo ''
                    echo 'âŒ Security testing at the end of development'
                    echo 'âŒ Vulnerabilities discovered in production'
                    echo 'âŒ Manual security reviews and audits'
                    echo 'âŒ Security patches applied reactively'
                    echo 'âŒ No automated security scanning'
                    echo ''
                    echo 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”'
                    echo '         NOW: DevSecOps Integration (The New Way)'
                    echo 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”'
                    echo ''
                    echo 'âœ¨ Security integrated into every build'
                    echo 'âœ¨ Automated vulnerability scanning'
                    echo 'âœ¨ Security gates in CI/CD pipeline'
                    echo 'âœ¨ Watch the security magic happen below...'
                    echo ''
                }
            }
        }
        
        stage('ğŸ” Code Security Analysis') {
            steps {
                script {
                    echo 'ğŸ” Scanning code for security vulnerabilities...'
                    def startTime = System.currentTimeMillis()
                    dir('Jenkins/jenkins-scenarios/scenario_05_security_sentinel') {
                        sh '''
                            echo "  âœ“ SAST scan: PASSED (0 vulnerabilities)"
                            echo "  âœ“ Dependency scan: PASSED (0 known CVEs)"
                            echo "  âœ“ Secret detection: PASSED (0 secrets found)"
                            echo "  âœ“ Code quality: EXCELLENT"
                        '''
                    }
                    def duration = (System.currentTimeMillis() - startTime) / 1000
                    echo "âœ… Code security analysis completed in ${duration} seconds!"
                }
            }
        }
        
        stage('ğŸ³ Container Security Scan') {
            steps {
                script {
                    echo 'ğŸ³ Building and scanning container for vulnerabilities...'
                    def startTime = System.currentTimeMillis()
                    dir('Jenkins/jenkins-scenarios/scenario_05_security_sentinel') {
                        def image = docker.build("${DOCKER_IMAGE}:${BUILD_NUMBER}", "--no-cache .")
                        echo "âœ… Image built: ${image.id}"
                        sh '''
                            echo "  âœ“ Container vulnerability scan: PASSED"
                            echo "  âœ“ Base image security: SECURE"
                            echo "  âœ“ Runtime security: CONFIGURED"
                            echo "  âœ“ Image signing: VERIFIED"
                        '''
                    }
                    def duration = (System.currentTimeMillis() - startTime) / 1000
                    echo "âœ… Container security scan completed in ${duration} seconds!"
                }
            }
        }
        
        stage('ğŸ”’ Security Testing Suite') {
            steps {
                script {
                    echo 'ğŸ”’ Running comprehensive security tests...'
                    def startTime = System.currentTimeMillis()
                    dir('Jenkins/jenkins-scenarios/scenario_05_security_sentinel') {
                        sh '''
                            echo "  âœ“ Authentication tests: PASSED"
                            echo "  âœ“ Authorization tests: PASSED"
                            echo "  âœ“ Input validation tests: PASSED"
                            echo "  âœ“ SQL injection tests: PASSED"
                            echo "  âœ“ XSS protection tests: PASSED"
                        '''
                    }
                    def duration = (System.currentTimeMillis() - startTime) / 1000
                    echo "âœ… Security tests completed in ${duration} seconds!"
                }
            }
        }
        
        stage('ğŸ›¡ï¸ Security Policy Enforcement') {
            steps {
                script {
                    echo 'ğŸ›¡ï¸ Enforcing security policies and compliance...'
                    def startTime = System.currentTimeMillis()
                    dir('Jenkins/jenkins-scenarios/scenario_05_security_sentinel') {
                        sh '''
                            echo "  âœ“ OWASP compliance: VERIFIED"
                            echo "  âœ“ CIS benchmarks: PASSED"
                            echo "  âœ“ GDPR compliance: VERIFIED"
                            echo "  âœ“ Security headers: CONFIGURED"
                            echo "  âœ“ TLS/SSL: ENABLED"
                        '''
                    }
                    def duration = (System.currentTimeMillis() - startTime) / 1000
                    echo "âœ… Security policies enforced in ${duration} seconds!"
                }
            }
        }
        
        stage('ğŸ¯ THE SECURITY SENTINEL TRANSFORMATION') {
            steps {
                script {
                    def totalDuration = currentBuild.duration / 1000
                    echo ''
                    echo 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”'
                    echo '              SECURITY SENTINEL TRANSFORMATION'
                    echo 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”'
                    echo ''
                    echo 'ğŸ“Š COMPARISON:'
                    echo ''
                    echo '  BEFORE (Reactive):                   AFTER (DevSecOps):'
                    echo '  âŒ Security at the end               âœ… Security in every build'
                    echo '  âŒ Vulnerabilities in production     âœ… Vulnerabilities caught early'
                    echo '  âŒ Manual security reviews           âœ… Automated security scanning'
                    echo '  âŒ Reactive patching                 âœ… Proactive security measures'
                    echo '  âŒ Security as bottleneck            âœ… Security as enabler'
                    echo ''
                    echo 'ğŸ’° BENEFITS:'
                    echo '  ğŸ¯ 100% automated security scanning'
                    echo '  ğŸš€ Security issues caught in minutes, not months'
                    echo '  ğŸ”’ Zero vulnerabilities in production'
                    echo '  ğŸ“Š Continuous security monitoring'
                    echo '  ğŸ›¡ï¸  Proactive threat protection'
                    echo '  âš¡ 10x faster security feedback'
                    echo ''
                    echo 'ğŸŒŸ This is not just security - This is PROTECTION'
                    echo ''
                    echo 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”'
                    echo ''
                    echo 'ğŸ‰ You just became a Security Sentinel!'
                    echo 'ğŸš€ Welcome to DevSecOps mastery!'
                    echo ''
                }
            }
        }
    }
    
    post {
        success {
            script {
                def totalDuration = currentBuild.duration / 1000
                echo ''
                echo 'âœ… Security Sentinel scenario completed!'
                echo ''
                echo "â±ï¸  Total time: ${totalDuration} seconds"
                echo 'ğŸ¯ Security: 100% automated'
                echo 'ğŸ”’ Vulnerabilities: 0 found'
                echo 'ğŸ›¡ï¸  Compliance: VERIFIED'
                echo ''
                echo 'ğŸ’¡ Remember: DevSecOps integrates security'
                echo '   into every build. This is the future!'
                echo ''
            }
        }
        failure {
            echo 'âŒ Security scan failed - but that\'s GOOD!'
            echo '   Security gates prevented vulnerable code from deploying!'
        }
    }
}