pipeline {
    agent any
    
    // Build options
    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 1, unit: 'HOURS')
        skipDefaultCheckout(true)
        timestamps()
    }
    
    parameters {
        // Enable/Disable each mini-scenario
        booleanParam(
            name: 'RUN_CONFIG_VALIDATION', 
            defaultValue: true, 
            description: 'âš™ï¸ Run Config Validation Tests'
        )
        booleanParam(
            name: 'RUN_API_HEALTH', 
            defaultValue: true, 
            description: 'ğŸ¥ Run API Health Check Tests'
        )
        booleanParam(
            name: 'RUN_POSTGRES', 
            defaultValue: true, 
            description: 'ğŸ˜ Run Postgres Database Tests'
        )
        booleanParam(
            name: 'RUN_REDIS', 
            defaultValue: true, 
            description: 'ğŸ“¦ Run Redis Cache Tests'
        )
        booleanParam(
            name: 'RUN_SECRET_SCAN', 
            defaultValue: true, 
            description: 'ğŸ” Run Secret Scanning Tests'
        )
        
        // Pass/Fail mode for each mini-scenario
        booleanParam(
            name: 'CONFIG_VALIDATION_PASS', 
            defaultValue: true, 
            description: 'âœ… Config Validation: Pass (true) or Fail (false)'
        )
        booleanParam(
            name: 'API_HEALTH_PASS', 
            defaultValue: true, 
            description: 'âœ… API Health: Pass (true) or Fail (false)'
        )
        booleanParam(
            name: 'POSTGRES_PASS', 
            defaultValue: true, 
            description: 'âœ… Postgres: Pass (true) or Fail (false)'
        )
        booleanParam(
            name: 'REDIS_PASS', 
            defaultValue: true, 
            description: 'âœ… Redis: Pass (true) or Fail (false)'
        )
        booleanParam(
            name: 'SECRET_SCAN_PASS', 
            defaultValue: true, 
            description: 'âœ… Secret Scan: Pass (true) or Fail (false)'
        )
    }
    
    environment {
        DOCKER_BUILDKIT = '1'
        PYTHONUNBUFFERED = '1'
        SCENARIO_NAME = 'scenario_03_html_reports'
        IMAGE_NAME = "chaos-workshop-scenario-03"
        BUILD_TAG = "${BUILD_NUMBER}"
        REPORTS_DIR = 'reports'
        GIT_REPO = 'https://github.com/vellankikoti/ci-cd-chaos-workshop.git'
        GIT_BRANCH = 'phase-3-jenkins'
        SCENARIO_PATH = 'Jenkins/jenkins_scenarios/scenario_03_html_reports'
    }
    
    stages {
        stage('ğŸ”„ Checkout and Verify') {
            steps {
                script {
                    echo """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                            ğŸ”„ CHECKING OUT CODE                             â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Repository: ${env.GIT_REPO}                                                 â•‘
â•‘  Branch: ${env.GIT_BRANCH}                                                   â•‘
â•‘  Scenario: ${env.SCENARIO_NAME}                                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    """
                    
                    // Checkout the repository
                    checkout scm
                    
                    // Verify scenario files exist
                    sh '''
                        echo "ğŸ“ Verifying scenario files..."
                        
                        # Check if scenario directory exists
                        if [ -d "${SCENARIO_PATH}" ]; then
                            echo "âœ… Scenario directory found: ${SCENARIO_PATH}"
                            ls -la "${SCENARIO_PATH}/"
                        else
                            echo "âŒ Scenario directory not found: ${SCENARIO_PATH}"
                            echo "ğŸ“‚ Available directories in Jenkins/jenkins_scenarios/:"
                            ls -la Jenkins/jenkins_scenarios/ || echo "Jenkins/jenkins_scenarios/ not found"
                            exit 1
                        fi
                        
                        # Check for required files
                        for file in Dockerfile requirements.txt report_generator.py; do
                            if [ -f "${SCENARIO_PATH}/${file}" ]; then
                                echo "âœ… ${file} found"
                            else
                                echo "âŒ ${file} not found in ${SCENARIO_PATH}"
                                exit 1
                            fi
                        done
                        
                        # Check for tests directory
                        if [ -d "${SCENARIO_PATH}/tests" ]; then
                            echo "âœ… Tests directory found"
                            echo "ğŸ“‹ Test files:"
                            ls -la "${SCENARIO_PATH}/tests/" | grep "test_.*\\.py" || echo "No test files found"
                        else
                            echo "âŒ Tests directory not found"
                            exit 1
                        fi
                        
                        # Check Docker is available
                        if command -v docker >/dev/null 2>&1; then
                            echo "âœ… Docker is available"
                            docker --version
                        else
                            echo "âŒ Docker not found"
                            exit 1
                        fi
                    '''
                }
            }
        }
        
        stage('ğŸª Initialize Scenario 03') {
            steps {
                script {
                    echo """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                   ğŸ“Š SCENARIO 03: HTML REPORTS CHAOS                        â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  ğŸ¯ MISSION: Master HTML test reporting under chaotic conditions            â•‘
â•‘  ğŸ“‹ MINI-SCENARIOS TO EXECUTE:                                              â•‘
â•‘  â€¢ Config Validation: ${params.RUN_CONFIG_VALIDATION ? 'âœ… ENABLED' : 'âŒ DISABLED'} (${params.CONFIG_VALIDATION_PASS ? 'PASS' : 'FAIL'} mode)   â•‘
â•‘  â€¢ API Health Check: ${params.RUN_API_HEALTH ? 'âœ… ENABLED' : 'âŒ DISABLED'} (${params.API_HEALTH_PASS ? 'PASS' : 'FAIL'} mode)    â•‘
â•‘  â€¢ Postgres Database: ${params.RUN_POSTGRES ? 'âœ… ENABLED' : 'âŒ DISABLED'} (${params.POSTGRES_PASS ? 'PASS' : 'FAIL'} mode)     â•‘
â•‘  â€¢ Redis Cache: ${params.RUN_REDIS ? 'âœ… ENABLED' : 'âŒ DISABLED'} (${params.REDIS_PASS ? 'PASS' : 'FAIL'} mode)          â•‘
â•‘  â€¢ Secret Scanning: ${params.RUN_SECRET_SCAN ? 'âœ… ENABLED' : 'âŒ DISABLED'} (${params.SECRET_SCAN_PASS ? 'PASS' : 'FAIL'} mode)    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    """
                    
                    // Create reports directory
                    sh """
                        echo "ğŸ“ Creating reports directory..."
                        mkdir -p ${REPORTS_DIR}
                        chmod 755 ${REPORTS_DIR}
                    """
                    
                    // Clean up any existing containers and images
                    sh """
                        echo "ğŸ§¹ Cleaning up previous Docker resources..."
                        docker container prune -f || true
                        docker image rm ${IMAGE_NAME}:${BUILD_TAG} || true
                        docker system prune -f || true
                    """
                }
            }
        }
        
        stage('ğŸ³ Build Docker Image') {
            steps {
                script {
                    echo """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                            ğŸ³ DOCKER BUILD PHASE                            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    """
                    
                    dir("${env.SCENARIO_PATH}") {
                        sh """
                            echo "ğŸ—ï¸ Building Docker image: ${IMAGE_NAME}:${BUILD_TAG}"
                            echo "ğŸ“‚ Current directory: \$(pwd)"
                            echo "ğŸ“‹ Files in directory:"
                            ls -la
                            
                            # Build the Docker image
                            docker build --no-cache -t ${IMAGE_NAME}:${BUILD_TAG} .
                            
                            echo "âœ… Docker build completed successfully"
                            
                            # Verify image was built
                            docker images | grep ${IMAGE_NAME} || echo "Warning: Image not found in docker images"
                            
                            # Test the image
                            docker run --rm ${IMAGE_NAME}:${BUILD_TAG} python --version
                            docker run --rm ${IMAGE_NAME}:${BUILD_TAG} pytest --version
                        """
                    }
                }
            }
        }
        
        stage('âš™ï¸ Config Validation Tests') {
            when {
                expression { return params.RUN_CONFIG_VALIDATION }
            }
            steps {
                script {
                    def testType = params.CONFIG_VALIDATION_PASS ? 'pass' : 'fail'
                    def status = params.CONFIG_VALIDATION_PASS ? 'âœ… PASS' : 'âŒ FAIL'
                    
                    echo """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                        âš™ï¸ CONFIG VALIDATION TESTS                           â•‘
â•‘  Status: ${status}                                                      â•‘
â•‘  Test Mode: ${testType.toUpperCase()}                                                       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    """
                    
                    try {
                        sh """
                            echo "ğŸ§ª Running Config Validation tests (${testType})..."
                            docker run --rm \
                                -v \$(pwd)/${REPORTS_DIR}:/app/reports \
                                -w /app \
                                ${IMAGE_NAME}:${BUILD_TAG} \
                                bash -c "
                                    pytest tests/test_config_validation_${testType}.py \
                                        --html=reports/config_validation_${testType}_report.html \
                                        --self-contained-html \
                                        --json-report \
                                        --json-report-file=reports/config_validation_${testType}_report.json \
                                        -v --tb=short --color=yes
                                "
                        """
                        echo "âœ… Config Validation tests completed successfully"
                    } catch (Exception e) {
                        echo "âŒ Config Validation tests failed (this might be intentional for learning)"
                        if (!params.CONFIG_VALIDATION_PASS) {
                            echo "ğŸ’¡ This failure was intentional to demonstrate config validation issues!"
                        }
                        // Don't fail the pipeline for educational failures
                        currentBuild.result = 'UNSTABLE'
                    }
                }
            }
        }
        
        stage('ğŸ¥ API Health Check Tests') {
            when {
                expression { return params.RUN_API_HEALTH }
            }
            steps {
                script {
                    def testType = params.API_HEALTH_PASS ? 'pass' : 'fail'
                    def status = params.API_HEALTH_PASS ? 'âœ… PASS' : 'âŒ FAIL'
                    
                    echo """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                          ğŸ¥ API HEALTH CHECK TESTS                          â•‘
â•‘  Status: ${status}                                                      â•‘
â•‘  Test Mode: ${testType.toUpperCase()}                                                       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    """
                    
                    try {
                        sh """
                            echo "ğŸ§ª Running API Health Check tests (${testType})..."
                            docker run --rm \
                                -v \$(pwd)/${REPORTS_DIR}:/app/reports \
                                -w /app \
                                ${IMAGE_NAME}:${BUILD_TAG} \
                                bash -c "
                                    pytest tests/test_api_health_${testType}.py \
                                        --html=reports/api_health_${testType}_report.html \
                                        --self-contained-html \
                                        --json-report \
                                        --json-report-file=reports/api_health_${testType}_report.json \
                                        -v --tb=short --color=yes
                                "
                        """
                        echo "âœ… API Health Check tests completed successfully"
                    } catch (Exception e) {
                        echo "âŒ API Health Check tests failed (this might be intentional for learning)"
                        if (!params.API_HEALTH_PASS) {
                            echo "ğŸ’¡ This failure was intentional to demonstrate API health check issues!"
                        }
                        currentBuild.result = 'UNSTABLE'
                    }
                }
            }
        }
        
        stage('ğŸ˜ Postgres Database Tests') {
            when {
                expression { return params.RUN_POSTGRES }
            }
            steps {
                script {
                    def testType = params.POSTGRES_PASS ? 'pass' : 'fail'
                    def status = params.POSTGRES_PASS ? 'âœ… PASS' : 'âŒ FAIL'
                    
                    echo """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                         ğŸ˜ POSTGRES DATABASE TESTS                          â•‘
â•‘  Status: ${status}                                                      â•‘
â•‘  Test Mode: ${testType.toUpperCase()}                                                       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    """
                    
                    try {
                        sh """
                            echo "ğŸ§ª Running Postgres Database tests (${testType})..."
                            docker run --rm \
                                -v /var/run/docker.sock:/var/run/docker.sock \
                                -v \$(pwd)/${REPORTS_DIR}:/app/reports \
                                -w /app \
                                ${IMAGE_NAME}:${BUILD_TAG} \
                                bash -c "
                                    pytest tests/test_postgres_${testType}.py \
                                        --html=reports/postgres_${testType}_report.html \
                                        --self-contained-html \
                                        --json-report \
                                        --json-report-file=reports/postgres_${testType}_report.json \
                                        -v --tb=short --color=yes
                                "
                        """
                        echo "âœ… Postgres Database tests completed successfully"
                    } catch (Exception e) {
                        echo "âŒ Postgres Database tests failed (this might be intentional for learning)"
                        if (!params.POSTGRES_PASS) {
                            echo "ğŸ’¡ This failure was intentional to demonstrate database connectivity issues!"
                        }
                        currentBuild.result = 'UNSTABLE'
                    }
                }
            }
        }
        
        stage('ğŸ“¦ Redis Cache Tests') {
            when {
                expression { return params.RUN_REDIS }
            }
            steps {
                script {
                    def testType = params.REDIS_PASS ? 'pass' : 'fail'
                    def status = params.REDIS_PASS ? 'âœ… PASS' : 'âŒ FAIL'
                    
                    echo """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                           ğŸ“¦ REDIS CACHE TESTS                              â•‘
â•‘  Status: ${status}                                                      â•‘
â•‘  Test Mode: ${testType.toUpperCase()}                                                       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    """
                    
                    try {
                        sh """
                            echo "ğŸ§ª Running Redis Cache tests (${testType})..."
                            docker run --rm \
                                -v /var/run/docker.sock:/var/run/docker.sock \
                                -v \$(pwd)/${REPORTS_DIR}:/app/reports \
                                -w /app \
                                ${IMAGE_NAME}:${BUILD_TAG} \
                                bash -c "
                                    pytest tests/test_redis_${testType}.py \
                                        --html=reports/redis_${testType}_report.html \
                                        --self-contained-html \
                                        --json-report \
                                        --json-report-file=reports/redis_${testType}_report.json \
                                        -v --tb=short --color=yes
                                "
                        """
                        echo "âœ… Redis Cache tests completed successfully"
                    } catch (Exception e) {
                        echo "âŒ Redis Cache tests failed (this might be intentional for learning)"
                        if (!params.REDIS_PASS) {
                            echo "ğŸ’¡ This failure was intentional to demonstrate cache connectivity issues!"
                        }
                        currentBuild.result = 'UNSTABLE'
                    }
                }
            }
        }
        
        stage('ğŸ” Secret Scanning Tests') {
            when {
                expression { return params.RUN_SECRET_SCAN }
            }
            steps {
                script {
                    def testType = params.SECRET_SCAN_PASS ? 'pass' : 'fail'
                    def status = params.SECRET_SCAN_PASS ? 'âœ… PASS' : 'âŒ FAIL'
                    
                    echo """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                          ğŸ” SECRET SCANNING TESTS                           â•‘
â•‘  Status: ${status}                                                      â•‘
â•‘  Test Mode: ${testType.toUpperCase()}                                                       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    """
                    
                    try {
                        sh """
                            echo "ğŸ§ª Running Secret Scanning tests (${testType})..."
                            docker run --rm \
                                -v \$(pwd)/${REPORTS_DIR}:/app/reports \
                                -w /app \
                                -e SECRET_API_KEY="demo-secret-key-12345" \
                                -e DATABASE_PASSWORD="super-secret-password" \
                                ${IMAGE_NAME}:${BUILD_TAG} \
                                bash -c "
                                    pytest tests/test_secret_scan_${testType}.py \
                                        --html=reports/secret_scan_${testType}_report.html \
                                        --self-contained-html \
                                        --json-report \
                                        --json-report-file=reports/secret_scan_${testType}_report.json \
                                        -v --tb=short --color=yes
                                "
                        """
                        echo "âœ… Secret Scanning tests completed successfully"
                    } catch (Exception e) {
                        echo "âŒ Secret Scanning tests failed (this might be intentional for learning)"
                        if (!params.SECRET_SCAN_PASS) {
                            echo "ğŸ’¡ This failure was intentional to demonstrate secret security issues!"
                        }
                        currentBuild.result = 'UNSTABLE'
                    }
                }
            }
        }
        
        stage('ğŸ¨ Generate Enterprise Reports') {
            steps {
                script {
                    echo """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                      ğŸ¨ GENERATING ENTERPRISE REPORTS                       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    """
                    
                    // Copy report generator from scenario directory
                    sh """
                        echo "ğŸ“‹ Copying report generator..."
                        cp ${SCENARIO_PATH}/report_generator.py .
                        chmod +x report_generator.py
                    """
                    
                    // Set environment variables for the report generator
                    def envVars = []
                    envVars.add("RUN_CONFIG_VALIDATION=${params.RUN_CONFIG_VALIDATION}")
                    envVars.add("CONFIG_VALIDATION_PASS=${params.CONFIG_VALIDATION_PASS}")
                    envVars.add("RUN_API_HEALTH=${params.RUN_API_HEALTH}")
                    envVars.add("API_HEALTH_PASS=${params.API_HEALTH_PASS}")
                    envVars.add("RUN_POSTGRES=${params.RUN_POSTGRES}")
                    envVars.add("POSTGRES_PASS=${params.POSTGRES_PASS}")
                    envVars.add("RUN_REDIS=${params.RUN_REDIS}")
                    envVars.add("REDIS_PASS=${params.REDIS_PASS}")
                    envVars.add("RUN_SECRET_SCAN=${params.RUN_SECRET_SCAN}")
                    envVars.add("SECRET_SCAN_PASS=${params.SECRET_SCAN_PASS}")
                    
                    withEnv(envVars) {
                        sh """
                            echo "ğŸ¨ Generating enterprise-grade reports..."
                            
                            # Run the enterprise report generator
                            docker run --rm \
                                -v \$(pwd)/${REPORTS_DIR}:/app/reports \
                                -v \$(pwd)/report_generator.py:/app/report_generator.py \
                                -w /app \
                                -e RUN_CONFIG_VALIDATION="${params.RUN_CONFIG_VALIDATION}" \
                                -e CONFIG_VALIDATION_PASS="${params.CONFIG_VALIDATION_PASS}" \
                                -e RUN_API_HEALTH="${params.RUN_API_HEALTH}" \
                                -e API_HEALTH_PASS="${params.API_HEALTH_PASS}" \
                                -e RUN_POSTGRES="${params.RUN_POSTGRES}" \
                                -e POSTGRES_PASS="${params.POSTGRES_PASS}" \
                                -e RUN_REDIS="${params.RUN_REDIS}" \
                                -e REDIS_PASS="${params.REDIS_PASS}" \
                                -e RUN_SECRET_SCAN="${params.RUN_SECRET_SCAN}" \
                                -e SECRET_SCAN_PASS="${params.SECRET_SCAN_PASS}" \
                                ${IMAGE_NAME}:${BUILD_TAG} \
                                python report_generator.py reports
                            
                            echo "âœ… Enterprise reports generated successfully!"
                            echo "ğŸ“‹ Generated reports:"
                            ls -la reports/ | grep "\\.html" || echo "No HTML reports found"
                        """
                    }
                    
                    echo """
ğŸ‰ STUNNING REPORTS GENERATED!

ğŸ“Š Available Reports:
â€¢ index.html - Main Dashboard (START HERE!)
â€¢ Individual scenario reports with beautiful visualizations
â€¢ Interactive charts and graphs
â€¢ Dark/light theme toggle
â€¢ Mobile-responsive design

ğŸ¯ Features Include:
â€¢ Real-time test metrics
â€¢ Pass/fail distribution charts
â€¢ Execution time analysis
â€¢ Color-coded status indicators
â€¢ Collapsible test details
â€¢ Professional enterprise design

ğŸ’¡ These reports will WOW your workshop attendees!
                    """
                }
            }
        }
    }
    
    post {
        always {
            script {
                echo """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                        ğŸ“Š ARCHIVING REPORTS & CLEANUP                       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                """
                
                // Archive all reports
                archiveArtifacts artifacts: 'reports/**/*', allowEmptyArchive: true, fingerprint: true
                
                echo """
ğŸ“Š ENTERPRISE REPORTS ARCHIVED SUCCESSFULLY!

ğŸ¯ How to view your stunning reports:
1. Go to this build's page in Jenkins
2. Click on "Artifacts" 
3. Download and open index.html (MAIN DASHBOARD)
4. Navigate through individual scenario reports
5. Toggle dark/light theme for optimal viewing
6. Share with your team for maximum impact!

ğŸ“‹ Available reports:
                """
                
                // List available reports
                sh '''
                    if [ -d "reports" ]; then
                        echo "ğŸ“ Enterprise Dashboard & Reports:"
                        find reports -name "*.html" -exec echo "   ğŸ¨ {}" \\;
                        echo ""
                        echo "ğŸ“„ Raw JSON data:"
                        find reports -name "*.json" -exec echo "   ğŸ“‹ {}" \\;
                    else
                        echo "âŒ No reports directory found"
                    fi
                '''
                
                echo """
ğŸ‰ SUCCESS! Your Scenario 03 chaos workshop has completed!

ğŸ“– What you accomplished:
â€¢ Built Docker images for isolated testing
â€¢ Executed multiple chaos testing scenarios
â€¢ Generated STUNNING enterprise-grade HTML reports
â€¢ Created interactive dashboards with charts and graphs
â€¢ Learned about CI/CD resilience patterns

ğŸš€ Next steps:
â€¢ Download and review the beautiful HTML reports
â€¢ Start with index.html for the main dashboard
â€¢ Experiment with different parameter combinations
â€¢ Try running some scenarios in FAIL mode for learning
â€¢ Share these gorgeous reports with your team!

ğŸ’¡ Pro tip: The reports include:
   â€¢ Interactive pie charts showing pass/fail distribution
   â€¢ Bar charts for performance analysis
   â€¢ Dark/light theme toggle
   â€¢ Mobile-responsive design
   â€¢ Professional color coding
   â€¢ Collapsible error details

ğŸª These reports will be remembered for LIFE!
                """
                
                // Clean up Docker resources
                sh '''
                    echo "ğŸ§¹ Cleaning up Docker resources..."
                    docker container prune -f || true
                    docker image rm ${IMAGE_NAME}:${BUILD_TAG} || true
                    docker system prune -f || true
                '''
            }
        }
        success {
            echo """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                     ğŸ‰ SCENARIO 03 COMPLETED SUCCESSFULLY! ğŸ‰               â•‘
â•‘  All enabled mini-scenarios have completed their test execution.            â•‘
â•‘  Download the archived reports to see STUNNING enterprise visualizations!  â•‘
â•‘  Your HTML reporting pipeline is now BULLETPROOF! ğŸ“Šâœ¨ğŸ¨                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            """
        }
        failure {
            echo """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    âš ï¸ SCENARIO 03 ENCOUNTERED FAILURES âš ï¸                   â•‘
â•‘  Some mini-scenarios failed - this might be intentional for learning!      â•‘
â•‘  Download the archived reports to understand what went wrong.               â•‘
â•‘  The beautiful reports will show you exactly what happened! ğŸ“ŠğŸ’ª            â•‘
â•‘  Remember: Every failure is a learning opportunity!                         â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            """
        }
        unstable {
            echo """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                          ğŸ”¶ SCENARIO 03 UNSTABLE BUILD ğŸ”¶                   â•‘
â•‘  Some tests were unstable - perfect for learning edge cases!               â•‘
â•‘  The enterprise reports will show detailed analysis of what happened.       â•‘
â•‘  Download and explore the beautiful visualizations! ğŸ¨ğŸ“Š                   â•‘
â•‘  Keep experimenting and learning! ğŸ”¬                                         â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            """
        }
    }
}