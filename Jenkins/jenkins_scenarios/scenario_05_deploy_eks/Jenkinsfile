pipeline {
    agent any
    
    parameters {
        string(
            name: 'CLUSTER_NAME',
            defaultValue: 'eks-cf-stack-eks-cluster',
            description: 'EKS cluster name to deploy to'
        )
        choice(
            name: 'AWS_REGION',
            choices: ['us-east-1', 'us-west-2', 'us-east-2', 'eu-west-1'],
            description: 'AWS region for EKS cluster'
        )
        booleanParam(
            name: 'RUN_SCENARIO_5',
            defaultValue: true,
            description: 'Run Scenario 5: EKS Deployment Testing'
        )
        booleanParam(
            name: 'SCENARIO_5_PASS',
            defaultValue: true,
            description: 'Run PASS test (successful deployment)'
        )
        booleanParam(
            name: 'SCENARIO_5_FAIL',
            defaultValue: true,
            description: 'Run FAIL test (chaos deployment failures)'
        )
        booleanParam(
            name: 'CLEANUP_AFTER_TESTS',
            defaultValue: true,
            description: 'Clean up Kubernetes resources after tests'
        )
    }
    
    environment {
        // Scenario 5 specific paths
        SCENARIO_5_PATH = "Jenkins/jenkins_scenarios/scenario_05_deploy_eks"
        SCENARIO_5_IMAGE = "chaos-workshop-scenario-5:${BUILD_NUMBER}"
        
        // AWS Configuration
        AWS_DEFAULT_REGION = "${params.AWS_REGION}"
        AWS_PAGER = ""
        AWS_CLI_AUTO_PROMPT = "off"
    }
    
    stages {
        stage('Checkout & Preparation') {
            when {
                expression { params.RUN_SCENARIO_5 == true }
            }
            
            steps {
                script {
                    echo """
ðŸš€ Starting Scenario 5: EKS Deployment Chaos Testing
ðŸ“‹ Configuration:
   â€¢ Cluster: ${params.CLUSTER_NAME}
   â€¢ Region: ${params.AWS_REGION}
   â€¢ Pass Test: ${params.SCENARIO_5_PASS}
   â€¢ Fail Test: ${params.SCENARIO_5_FAIL}
   â€¢ Build: ${BUILD_NUMBER}
   â€¢ Scenario Path: ${env.SCENARIO_5_PATH}
                    """
                }
                
                // Verify the scenario directory structure
                sh '''
                    echo "ðŸ“‚ Verifying scenario directory structure..."
                    
                    if [ -d "${SCENARIO_5_PATH}" ]; then
                        echo "âœ… Scenario 5 directory found"
                        cd "${SCENARIO_5_PATH}"
                        
                        echo "ðŸ“‹ Files in scenario directory:"
                        ls -la
                        
                        echo "ðŸ“‹ Required files check:"
                        [ -f "Dockerfile" ] && echo "âœ… Dockerfile found" || echo "âŒ Dockerfile missing"
                        [ -f "requirements.txt" ] && echo "âœ… requirements.txt found" || echo "âŒ requirements.txt missing"
                        [ -f "run_tests.py" ] && echo "âœ… run_tests.py found" || echo "âŒ run_tests.py missing"
                        [ -d "tests" ] && echo "âœ… tests directory found" || echo "âŒ tests directory missing"
                        
                        if [ -d "tests" ]; then
                            echo "ðŸ“‹ Test files:"
                            ls -la tests/
                            echo "ðŸ“‹ Deploy files:"
                            ls -la tests/deploy/ 2>/dev/null || echo "âš ï¸ tests/deploy directory not found"
                        fi
                        
                        # Create reports directory
                        mkdir -p reports
                        echo "âœ… Preparation completed"
                        
                    else
                        echo "âŒ Scenario 5 directory not found at: ${SCENARIO_5_PATH}"
                        echo "ðŸ“‚ Available directories:"
                        find . -name "*scenario*" -type d | head -10
                        exit 1
                    fi
                '''
            }
        }
        
        stage('Build Docker Image') {
            when {
                expression { params.RUN_SCENARIO_5 == true }
            }
            
            steps {
                script {
                    echo "ðŸ³ Building Docker image for Scenario 5..."
                    
                    dir(env.SCENARIO_5_PATH) {
                        // Build the Docker image from the correct directory
                        sh '''
                            echo "ðŸ“ Current directory: $(pwd)"
                            echo "ðŸ“‹ Building image: ${SCENARIO_5_IMAGE}"
                            
                            docker build -t "${SCENARIO_5_IMAGE}" --no-cache .
                            
                            if [ $? -eq 0 ]; then
                                echo "âœ… Docker image built successfully"
                                docker images | grep chaos-workshop-scenario-5
                            else
                                echo "âŒ Docker build failed"
                                exit 1
                            fi
                        '''
                    }
                }
            }
        }
        
        stage('Setup AWS & Kubernetes') {
            when {
                expression { params.RUN_SCENARIO_5 == true }
            }
            
            steps {
                script {
                    echo "ðŸ” Setting up AWS and Kubernetes access..."
                    
                    withCredentials([
                        usernamePassword(
                            credentialsId: 'aws-credentials',
                            usernameVariable: 'AWS_ACCESS_KEY_ID',
                            passwordVariable: 'AWS_SECRET_ACCESS_KEY'
                        )
                    ]) {
                        
                        dir(env.SCENARIO_5_PATH) {
                            sh '''
                                export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
                                export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
                                export AWS_DEFAULT_REGION=${AWS_REGION}
                                
                                echo "ðŸ” Testing AWS authentication..."
                                aws --version || (echo "Installing AWS CLI..." && curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip" && unzip awscliv2.zip && ./aws/install)
                                
                                aws sts get-caller-identity
                                
                                echo "ðŸ” Checking EKS cluster..."
                                aws eks describe-cluster --name "${CLUSTER_NAME}" --region "${AWS_REGION}" --query 'cluster.{Status:status,Version:version}'
                                
                                echo "âš™ï¸ Creating kubeconfig..."
                                aws eks update-kubeconfig --region "${AWS_REGION}" --name "${CLUSTER_NAME}" --kubeconfig ./kubeconfig
                                
                                if [ -f ./kubeconfig ]; then
                                    echo "âœ… Kubeconfig created successfully"
                                    ls -la ./kubeconfig
                                else
                                    echo "âŒ Failed to create kubeconfig"
                                    exit 1
                                fi
                                
                                echo "ðŸ” Testing kubectl access..."
                                export KUBECONFIG=./kubeconfig
                                
                                # Install kubectl if needed
                                kubectl version --client=true || (echo "Installing kubectl..." && curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl" && chmod +x kubectl && mv kubectl /usr/local/bin/)
                                
                                # Test kubectl access
                                if kubectl cluster-info --request-timeout=30s; then
                                    echo "âœ… kubectl access confirmed"
                                else
                                    echo "âš ï¸ kubectl access failed - this is expected if your user isn't in aws-auth ConfigMap"
                                    echo "âœ… AWS authentication works - kubeconfig created successfully"
                                fi
                                
                                echo "âœ… Setup completed!"
                            '''
                        }
                    }
                }
            }
        }
        
        stage('Run EKS Tests') {
            when {
                expression { params.RUN_SCENARIO_5 == true }
            }
            
            parallel {
                stage('PASS Test') {
                    when {
                        expression { params.SCENARIO_5_PASS == true }
                    }
                    
                    steps {
                        script {
                            echo "âœ… Running PASS test..."
                            
                            withCredentials([
                                usernamePassword(
                                    credentialsId: 'aws-credentials',
                                    usernameVariable: 'AWS_ACCESS_KEY_ID',
                                    passwordVariable: 'AWS_SECRET_ACCESS_KEY'
                                )
                            ]) {
                                
                                dir(env.SCENARIO_5_PATH) {
                                    sh '''
                                        echo "ðŸš€ Executing PASS test..."
                                        
                                        docker run --rm \\
                                            -e AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID} \\
                                            -e AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY} \\
                                            -e AWS_DEFAULT_REGION=${AWS_REGION} \\
                                            -e KUBECONFIG=/root/.kube/config \\
                                            -e PYTHONUNBUFFERED=1 \\
                                            -v $(pwd)/kubeconfig:/root/.kube/config:ro \\
                                            -v $(pwd)/reports:/app/reports \\
                                            --name scenario-5-pass-${BUILD_NUMBER} \\
                                            ${SCENARIO_5_IMAGE} \\
                                            python run_tests.py --pass-only
                                        
                                        echo "âœ… PASS test completed"
                                    '''
                                }
                            }
                        }
                    }
                    
                    post {
                        always {
                            dir(env.SCENARIO_5_PATH) {
                                sh '''
                                    docker logs scenario-5-pass-${BUILD_NUMBER} > reports/pass-test-logs.txt 2>&1 || true
                                    docker rm -f scenario-5-pass-${BUILD_NUMBER} || true
                                '''
                            }
                        }
                    }
                }
                
                stage('FAIL Test') {
                    when {
                        expression { params.SCENARIO_5_FAIL == true }
                    }
                    
                    steps {
                        script {
                            echo "ðŸ’¥ Running FAIL test..."
                            
                            withCredentials([
                                usernamePassword(
                                    credentialsId: 'aws-credentials',
                                    usernameVariable: 'AWS_ACCESS_KEY_ID',
                                    passwordVariable: 'AWS_SECRET_ACCESS_KEY'
                                )
                            ]) {
                                
                                dir(env.SCENARIO_5_PATH) {
                                    sh '''
                                        echo "ðŸ’¥ Executing FAIL test..."
                                        
                                        docker run --rm \\
                                            -e AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID} \\
                                            -e AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY} \\
                                            -e AWS_DEFAULT_REGION=${AWS_REGION} \\
                                            -e KUBECONFIG=/root/.kube/config \\
                                            -e PYTHONUNBUFFERED=1 \\
                                            -v $(pwd)/kubeconfig:/root/.kube/config:ro \\
                                            -v $(pwd)/reports:/app/reports \\
                                            --name scenario-5-fail-${BUILD_NUMBER} \\
                                            ${SCENARIO_5_IMAGE} \\
                                            python run_tests.py --fail-only
                                        
                                        echo "âœ… FAIL test completed"
                                    '''
                                }
                            }
                        }
                    }
                    
                    post {
                        always {
                            dir(env.SCENARIO_5_PATH) {
                                sh '''
                                    docker logs scenario-5-fail-${BUILD_NUMBER} > reports/fail-test-logs.txt 2>&1 || true
                                    docker rm -f scenario-5-fail-${BUILD_NUMBER} || true
                                '''
                            }
                        }
                    }
                }
            }
        }
        
        stage('Generate Reports') {
            when {
                expression { params.RUN_SCENARIO_5 == true }
            }
            
            steps {
                script {
                    echo "ðŸ“Š Generating reports..."
                    
                    dir(env.SCENARIO_5_PATH) {
                        sh '''
                            echo "ðŸ“ˆ Creating final reports..."
                            
                            # List generated reports
                            echo "ðŸ“‚ Generated reports:"
                            ls -la reports/ || echo "No reports generated"
                            
                            # Create summary
                            cat > reports/scenario-5-summary.json << EOF
{
    "scenario": "scenario_05_deploy_eks",
    "build_number": "${BUILD_NUMBER}",
    "cluster_name": "${CLUSTER_NAME}",
    "aws_region": "${AWS_REGION}",
    "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
    "tests_executed": {
        "pass_test": ${SCENARIO_5_PASS},
        "fail_test": ${SCENARIO_5_FAIL}
    },
    "jenkins_url": "${BUILD_URL}"
}
EOF
                            
                            echo "ðŸ“‹ Final Summary:"
                            cat reports/scenario-5-summary.json
                        '''
                    }
                }
            }
        }
        
        stage('Cleanup') {
            when {
                allOf {
                    expression { params.RUN_SCENARIO_5 == true }
                    expression { params.CLEANUP_AFTER_TESTS == true }
                }
            }
            
            steps {
                script {
                    echo "ðŸ§¹ Cleaning up resources..."
                    
                    withCredentials([
                        usernamePassword(
                            credentialsId: 'aws-credentials',
                            usernameVariable: 'AWS_ACCESS_KEY_ID',
                            passwordVariable: 'AWS_SECRET_ACCESS_KEY'
                        )
                    ]) {
                        
                        dir(env.SCENARIO_5_PATH) {
                            sh '''
                                echo "ðŸ—‘ï¸ Removing test resources from cluster..."
                                
                                docker run --rm \\
                                    -e AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID} \\
                                    -e AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY} \\
                                    -e AWS_DEFAULT_REGION=${AWS_REGION} \\
                                    -e KUBECONFIG=/root/.kube/config \\
                                    -v $(pwd)/kubeconfig:/root/.kube/config:ro \\
                                    ${SCENARIO_5_IMAGE} \\
                                    /bin/bash -c "
                                        kubectl delete deployment chaos-workshop-app --ignore-not-found=true
                                        kubectl delete service chaos-workshop-app-service --ignore-not-found=true
                                        kubectl delete configmap chaos-workshop-app-config --ignore-not-found=true
                                        echo 'âœ… Cleanup completed'
                                    "
                            '''
                        }
                    }
                }
            }
        }
    }
    
    post {
        always {
            script {
                echo "ðŸ“¦ Archiving artifacts..."
                
                dir(env.SCENARIO_5_PATH) {
                    // Archive reports
                    archiveArtifacts artifacts: 'reports/**/*', 
                                   allowEmptyArchive: true,
                                   fingerprint: true
                    
                    // Archive kubeconfig
                    archiveArtifacts artifacts: 'kubeconfig', 
                                   allowEmptyArchive: true,
                                   fingerprint: true
                    
                    // Simple HTML report publishing without plugin
                    script {
                        if (fileExists('reports/eks_deployment_report.html')) {
                            echo "ðŸ“Š HTML Report generated successfully"
                            echo "ðŸ“‹ Report available in archived artifacts"
                        } else {
                            echo "âš ï¸ No HTML report found"
                        }
                    }
                }
            }
        }
        
        success {
            echo """
âœ… Scenario 5 completed successfully!
ðŸ“Š Check the archived artifacts for detailed reports
ðŸŽ¯ Workshop attendees can now see real EKS chaos testing results!
            """
        }
        
        failure {
            dir(env.SCENARIO_5_PATH) {
                sh '''
                    echo "âŒ Collecting diagnostic info..."
                    echo "=== Directory Contents ==="
                    ls -la
                    echo "=== Reports ==="
                    ls -la reports/ || echo "No reports"
                    echo "=== Docker Images ==="
                    docker images | grep scenario-5 || echo "No images"
                '''
            }
        }
        
        cleanup {
            sh '''
                # Clean up containers and images
                docker rm -f scenario-5-pass-${BUILD_NUMBER} scenario-5-fail-${BUILD_NUMBER} 2>/dev/null || true
                docker rmi ${SCENARIO_5_IMAGE} 2>/dev/null || true
            '''
        }
    }
}